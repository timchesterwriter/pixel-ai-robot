<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0e14">
    <title>Pixel AI - –£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò === */
        :root {
            --primary: #00ff9d;
            --secondary: #0094ff;
            --accent: #ff00e5;
            --danger: #ff4757;
            --warning: #ffaa00;
            --success: #00d2ff;
            
            --bg-dark: #0a0e14;
            --bg-darker: #05080c;
            --bg-card: #1a1f2e;
            --bg-input: #131823;
            
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            
            --border: rgba(0, 255, 157, 0.1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.5);
            
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--secondary));
            
            --border-radius: 12px;
            --border-radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* === –ö–û–ù–¢–ï–ô–ù–ï–†–´ === */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === –®–ê–ü–ö–ê === */
        .header {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: bold;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* === –í–´–ë–û–† –Ø–ó–´–ö–ê === */
        .language-switcher {
            display: flex;
            gap: 5px;
            background: var(--bg-input);
            border-radius: 20px;
            padding: 5px;
            border: 1px solid var(--border);
        }

        .lang-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            min-width: 60px;
            text-align: center;
        }

        .lang-btn:hover {
            background: rgba(0, 255, 157, 0.1);
        }

        .lang-btn.active {
            background: var(--primary);
            color: var(--bg-dark);
            font-weight: 600;
        }

        /* === –û–°–ù–û–í–ù–û–ô –ú–ê–ö–ï–¢ === */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            flex: 1;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 300px 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .chat-area {
                order: 1;
            }
        }

        /* === –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ === */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* === –ß–ê–¢ === */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 600px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: var(--primary);
            color: var(--bg-dark);
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            align-self: flex-start;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-bottom-left-radius: 5px;
        }

        .message.system {
            align-self: center;
            background: rgba(0, 148, 255, 0.1);
            border: 1px solid rgba(0, 148, 255, 0.2);
            max-width: 90%;
            text-align: center;
            font-size: 14px;
            padding: 12px 20px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        /* === –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê === */
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 15px;
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            min-height: 60px;
            max-height: 150px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 157, 0.1);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--border-radius);
            color: var(--bg-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* === –ö–ê–†–¢–û–ß–ö–ò === */
        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .card-title i {
            color: var(--primary);
        }

        /* === –§–û–†–ú–´ === */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 157, 0.1);
        }

        /* === –ú–û–î–ï–õ–ò AI === */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .model-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .model-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .model-card.active {
            border-color: var(--primary);
            background: rgba(0, 255, 157, 0.1);
        }

        .model-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .model-provider {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* === –ö–ù–û–ü–ö–ò === */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--border-radius-sm);
            color: var(--bg-dark);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 157, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* === –ú–ò–ö–†–û–§–û–ù === */
        .mic-container {
            text-align: center;
            margin: 20px 0;
        }

        .mic-btn {
            width: 70px;
            height: 70px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--bg-dark);
            margin: 0 auto;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .mic-btn.listening {
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 30px rgba(0, 255, 157, 0.3);
        }

        .mic-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            animation: none;
        }

        .mic-status {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            min-height: 20px;
        }

        /* === –°–¢–ê–¢–£–° === */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .status-item {
            background: var(--bg-input);
            border-radius: var(--border-radius-sm);
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .status-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .status-value {
            font-size: 14px;
            font-weight: 600;
        }

        .status-value.active {
            color: var(--success);
        }

        .status-value.inactive {
            color: var(--text-secondary);
        }

        /* === –ê–ù–ò–ú–ê–¶–ò–ò === */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 255, 157, 0.4);
            }
            50% {
                box-shadow: 0 0 40px rgba(0, 255, 157, 0.6);
            }
        }

        /* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            border-radius: var(--border-radius-sm);
            padding: 15px 20px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* === –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø === */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .header-controls {
                justify-content: center;
            }
            
            .chat-messages {
                padding: 15px;
                max-height: 500px;
            }
            
            .message {
                max-width: 95%;
                padding: 12px 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .models-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="logo-text">Pixel AI</div>
            </div>
            
            <div class="header-controls">
                <div class="language-switcher">
                    <button class="lang-btn active" data-lang="ru">
                        <i class="fas fa-language"></i> –†—É—Å—Å–∫–∏–π
                    </button>
                    <button class="lang-btn" data-lang="en">
                        <i class="fas fa-language"></i> English
                    </button>
                </div>
            </div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –º–∞–∫–µ—Ç -->
        <div class="main-layout">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <aside class="sidebar">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-brain"></i>
                        <span data-translate="ai_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI</span>
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label" data-translate="api_key">OpenRouter API Key</label>
                        <input type="password" class="form-control" id="apiKey" 
                               placeholder="sk-or-v1-..." autocomplete="off">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;" data-translate="api_key_hint">
                            –ü–æ–ª—É—á–∏—Ç–µ –Ω–∞ openrouter.ai
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-translate="ai_model">–ú–æ–¥–µ–ª—å AI</label>
                        <div class="models-grid" id="modelGrid">
                            <div class="model-card active" data-model="arcee-ai/trinity-large-preview:free">
                                <div class="model-name">Trinity Large</div>
                                <div class="model-provider">Arcee AI</div>
                            </div>
                            <div class="model-card" data-model="nvidia/nemotron-nano-12b-v2-vl:free">
                                <div class="model-name">Nemotron Nano</div>
                                <div class="model-provider">NVIDIA</div>
                            </div>
                            <div class="model-card" data-model="qwen/qwen3-next-80b-a3b-instruct:free">
                                <div class="model-name">Qwen3 Next</div>
                                <div class="model-provider">Qwen</div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" id="saveSettings">
                        <i class="fas fa-save"></i>
                        <span data-translate="save_settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </button>
                </div>

                <!-- –ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-microphone"></i>
                        <span data-translate="voice_control">–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                    </h3>
                    
                    <div class="mic-container">
                        <button class="mic-btn" id="micBtn" disabled>
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="mic-status" id="micStatus" data-translate="mic_disabled">
                            –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–µ–Ω
                        </div>
                    </div>
                    
                    <div style="text-align: center; font-size: 14px; color: var(--text-secondary); margin-top: 10px;">
                        <span data-translate="activation_hint">–°–∫–∞–∂–∏—Ç–µ </span>
                        <strong id="activationPhraseText">"–ü–∏–∫—Å–µ–ª—å"</strong>
                        <span data-translate="to_activate"> –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</span>
                    </div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESP32 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-microchip"></i>
                        <span data-translate="esp32_control">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESP32</span>
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label" data-translate="esp32_ip">IP –∞–¥—Ä–µ—Å ESP32</label>
                        <input type="text" class="form-control" id="espIp" 
                               placeholder="192.168.1.100" autocomplete="off">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;" data-translate="esp32_hint">
                            –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ ESP32
                        </div>
                    </div>
                    
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label" data-translate="connection">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</div>
                            <div class="status-value inactive" id="espStatus">
                                <span data-translate="not_connected">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label" data-translate="led_status">LED —Å—Ç–∞—Ç—É—Å</div>
                            <div class="status-value inactive" id="ledStatus">
                                <span data-translate="off">–í—ã–∫–ª—é—á–µ–Ω</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" id="testESP32" disabled>
                        <i class="fas fa-wifi"></i>
                        <span data-translate="test_connection">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</span>
                    </button>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
                <div class="card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        <span data-translate="system_status">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</span>
                    </h3>
                    
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label" data-translate="ai">AI</div>
                            <div class="status-value inactive" id="aiStatus">
                                <span data-translate="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω–æ</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label" data-translate="voice">–ì–æ–ª–æ—Å</div>
                            <div class="status-value inactive" id="voiceStatus">
                                <span data-translate="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω–æ</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label" data-translate="mode">–†–µ–∂–∏–º</div>
                            <div class="status-value" id="modeStatus" data-translate="waiting">
                                –û–∂–∏–¥–∞–Ω–∏–µ
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label" data-translate="language">–Ø–∑—ã–∫</div>
                            <div class="status-value" id="langStatus">RU</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" id="resetSystem">
                        <i class="fas fa-redo"></i>
                        <span data-translate="reset_system">–°–±—Ä–æ—Å–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</span>
                    </button>
                </div>
            </aside>

            <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
            <main class="chat-area">
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        <span data-translate="welcome_message">
                            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Pixel AI! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á OpenRouter –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å AI.
                        </span>
                        <div class="message-time" id="currentTime"></div>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea class="chat-input" id="chatInput" 
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Å–∫–∞–∂–∏—Ç–µ '–ü–∏–∫—Å–µ–ª—å' –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–º..."
                                  data-translate-placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                        <button class="send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notificationContainer"></div>

    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ============================================
        const AppConfig = {
            languages: {
                ru: {
                    // –ù–∞–∑–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    ai_settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI",
                    api_key: "OpenRouter API Key",
                    api_key_hint: "–ü–æ–ª—É—á–∏—Ç–µ –Ω–∞ openrouter.ai",
                    ai_model: "–ú–æ–¥–µ–ª—å AI",
                    save_settings: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
                    voice_control: "–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
                    mic_disabled: "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–µ–Ω",
                    mic_enabled: "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω",
                    mic_listening: "–°–ª—É—à–∞—é...",
                    activation_hint: "–°–∫–∞–∂–∏—Ç–µ ",
                    to_activate: " –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏",
                    esp32_control: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESP32",
                    esp32_ip: "IP –∞–¥—Ä–µ—Å ESP32",
                    esp32_hint: "–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ ESP32",
                    connection: "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ",
                    not_connected: "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω",
                    connected: "–ü–æ–¥–∫–ª—é—á–µ–Ω",
                    led_status: "LED —Å—Ç–∞—Ç—É—Å",
                    off: "–í—ã–∫–ª—é—á–µ–Ω",
                    on: "–í–∫–ª—é—á–µ–Ω",
                    test_connection: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ",
                    system_status: "–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã",
                    ai: "AI",
                    voice: "–ì–æ–ª–æ—Å",
                    mode: "–†–µ–∂–∏–º",
                    waiting: "–û–∂–∏–¥–∞–Ω–∏–µ",
                    listening: "–°–ª—É—à–∞—é",
                    processing: "–û–±—Ä–∞–±–æ—Ç–∫–∞",
                    language: "–Ø–∑—ã–∫",
                    inactive: "–ù–µ–∞–∫—Ç–∏–≤–Ω–æ",
                    active: "–ê–∫—Ç–∏–≤–Ω–æ",
                    reset_system: "–°–±—Ä–æ—Å–∏—Ç—å —Å–∏—Å—Ç–µ–º—É",
                    
                    // –°–æ–æ–±—â–µ–Ω–∏—è
                    welcome_message: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Pixel AI! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á OpenRouter –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å AI.",
                    placeholder: "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Å–∫–∞–∂–∏—Ç–µ '–ü–∏–∫—Å–µ–ª—å' –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–º...",
                    settings_saved: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã",
                    api_key_required: "–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á",
                    select_model: "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å AI",
                    system_ready: "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞",
                    activation_phrase: "–ü–∏–∫—Å–µ–ª—å",
                    activation_response: "–°–ª—É—à–∞—é –≤–∞—Å",
                    command_sent: "–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞",
                    esp32_connected: "ESP32 –ø–æ–¥–∫–ª—é—á–µ–Ω",
                    esp32_disconnected: "ESP32 –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω"
                },
                en: {
                    // Element names
                    ai_settings: "AI Settings",
                    api_key: "OpenRouter API Key",
                    api_key_hint: "Get it at openrouter.ai",
                    ai_model: "AI Model",
                    save_settings: "Save Settings",
                    voice_control: "Voice Control",
                    mic_disabled: "Microphone disabled",
                    mic_enabled: "Microphone enabled",
                    mic_listening: "Listening...",
                    activation_hint: "Say ",
                    to_activate: " to activate",
                    esp32_control: "ESP32 Control",
                    esp32_ip: "ESP32 IP Address",
                    esp32_hint: "Leave empty to work without ESP32",
                    connection: "Connection",
                    not_connected: "Not connected",
                    connected: "Connected",
                    led_status: "LED Status",
                    off: "Off",
                    on: "On",
                    test_connection: "Test Connection",
                    system_status: "System Status",
                    ai: "AI",
                    voice: "Voice",
                    mode: "Mode",
                    waiting: "Waiting",
                    listening: "Listening",
                    processing: "Processing",
                    language: "Language",
                    inactive: "Inactive",
                    active: "Active",
                    reset_system: "Reset System",
                    
                    // Messages
                    welcome_message: "Welcome to Pixel AI! Enter your OpenRouter API key and select an AI model to get started.",
                    placeholder: "Type a message or say 'Pixel' to activate voice...",
                    settings_saved: "Settings saved",
                    api_key_required: "Enter API key",
                    select_model: "Select AI model",
                    system_ready: "System ready",
                    activation_phrase: "Pixel",
                    activation_response: "I'm listening",
                    command_sent: "Command sent",
                    esp32_connected: "ESP32 connected",
                    esp32_disconnected: "ESP32 not connected"
                }
            }
        };

        const AppState = {
            currentLang: 'ru',
            apiKey: '',
            selectedModel: 'arcee-ai/trinity-large-preview:free',
            espIp: '',
            espConnected: false,
            ledState: 'off',
            voiceActive: false,
            isListening: false,
            isProcessing: false,
            speechRecognition: null,
            speechSynthesis: window.speechSynthesis || null,
            wakeLock: null,
            retryCount: 0,
            maxRetries: 3
        };

        // ============================================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================
        function getTranslation(key) {
            return AppConfig.languages[AppState.currentLang][key] || key;
        }

        function updateTranslations() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = getTranslation(key);
                } else {
                    el.textContent = getTranslation(key);
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É
            document.getElementById('activationPhraseText').textContent = 
                `"${getTranslation('activation_phrase')}"`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —è–∑—ã–∫–∞
            document.getElementById('langStatus').textContent = 
                AppState.currentLang.toUpperCase();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º placeholder —á–∞—Ç–∞
            const chatInput = document.getElementById('chatInput');
            chatInput.placeholder = getTranslation('placeholder');
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${icons[type] || 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, duration);
            
            return notification;
        }

        function getTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function updateTime() {
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = getTimestamp();
            }
        }

        function addMessageToChat(text, type = 'system') {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${getTimestamp()}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messages = chatMessages.querySelectorAll('.message');
            if (messages.length > 100) {
                messages[0].remove();
            }
        }

        // ============================================
        // –†–ê–ë–û–¢–ê –° –ù–ê–°–¢–†–û–ô–ö–ê–ú–ò
        // ============================================
        function loadSettings() {
            try {
                const savedApiKey = localStorage.getItem('pixel_ai_api_key');
                const savedModel = localStorage.getItem('pixel_ai_model');
                const savedEspIp = localStorage.getItem('pixel_ai_esp_ip');
                const savedLang = localStorage.getItem('pixel_ai_lang');
                
                if (savedApiKey) {
                    document.getElementById('apiKey').value = savedApiKey;
                    AppState.apiKey = savedApiKey;
                }
                
                if (savedModel) {
                    AppState.selectedModel = savedModel;
                    document.querySelectorAll('.model-card').forEach(card => {
                        card.classList.remove('active');
                        if (card.dataset.model === savedModel) {
                            card.classList.add('active');
                        }
                    });
                }
                
                if (savedEspIp) {
                    document.getElementById('espIp').value = savedEspIp;
                    AppState.espIp = savedEspIp;
                    document.getElementById('testESP32').disabled = false;
                }
                
                if (savedLang) {
                    AppState.currentLang = savedLang;
                    document.querySelectorAll('.lang-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.lang === savedLang) {
                            btn.classList.add('active');
                        }
                    });
                }
                
                updateTranslations();
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const espIp = document.getElementById('espIp').value.trim();
            
            if (!apiKey) {
                showNotification(getTranslation('api_key_required'), 'warning');
                return false;
            }
            
            AppState.apiKey = apiKey;
            AppState.espIp = espIp;
            
            localStorage.setItem('pixel_ai_api_key', apiKey);
            localStorage.setItem('pixel_ai_model', AppState.selectedModel);
            localStorage.setItem('pixel_ai_esp_ip', espIp);
            localStorage.setItem('pixel_ai_lang', AppState.currentLang);
            
            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('micBtn').disabled = false;
            document.getElementById('testESP32').disabled = !espIp;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å AI
            document.getElementById('aiStatus').textContent = getTranslation('active');
            document.getElementById('aiStatus').className = 'status-value active';
            
            showNotification(getTranslation('settings_saved'), 'success');
            addMessageToChat(getTranslation('system_ready'), 'system');
            
            return true;
        }

        // ============================================
        // –ì–û–õ–û–°–û–í–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï
        // ============================================
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
                return false;
            }
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                AppState.speechRecognition = new SpeechRecognition();
                
                AppState.speechRecognition.continuous = true;
                AppState.speechRecognition.interimResults = false;
                AppState.speechRecognition.lang = AppState.currentLang === 'ru' ? 'ru-RU' : 'en-US';
                AppState.speechRecognition.maxAlternatives = 1;
                
                AppState.speechRecognition.onstart = () => {
                    AppState.isListening = true;
                    document.getElementById('micBtn').classList.add('listening');
                    document.getElementById('micStatus').textContent = getTranslation('mic_listening');
                    document.getElementById('voiceStatus').textContent = getTranslation('active');
                    document.getElementById('voiceStatus').className = 'status-value active';
                    document.getElementById('modeStatus').textContent = getTranslation('listening');
                    
                    addMessageToChat(getTranslation('mic_listening'), 'system');
                };
                
                AppState.speechRecognition.onresult = (event) => {
                    const result = event.results[event.results.length - 1];
                    const transcript = result[0].transcript.toLowerCase().trim();
                    
                    addMessageToChat(`üé§ ${transcript}`, 'user');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É
                    const activationPhrase = getTranslation('activation_phrase').toLowerCase();
                    if (transcript.includes(activationPhrase)) {
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                        AppState.speechRecognition.stop();
                        
                        // –†–æ–±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç
                        speak(getTranslation('activation_response'));
                        
                        // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
                        setTimeout(() => {
                            startCommandListening();
                        }, 1000);
                    }
                };
                
                AppState.speechRecognition.onerror = (event) => {
                    if (event.error === 'no-speech' || event.error === 'audio-capture') {
                        // –¢–∏—Ö–∏–µ –æ—à–∏–±–∫–∏, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        return;
                    }
                    
                    console.error('Speech recognition error:', event.error);
                    
                    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                    if (AppState.voiceActive) {
                        setTimeout(() => {
                            if (AppState.voiceActive) {
                                AppState.speechRecognition.start();
                            }
                        }, 1000);
                    }
                };
                
                AppState.speechRecognition.onend = () => {
                    AppState.isListening = false;
                    document.getElementById('micBtn').classList.remove('listening');
                    
                    if (AppState.voiceActive) {
                        // –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
                        setTimeout(() => {
                            if (AppState.voiceActive && !AppState.isProcessing) {
                                AppState.speechRecognition.start();
                            }
                        }, 500);
                    }
                };
                
                return true;
                
            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è', 'error');
                return false;
            }
        }

        function startCommandListening() {
            if (!AppState.speechRecognition) return;
            
            // –ú–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥
            AppState.speechRecognition.onresult = (event) => {
                const result = event.results[event.results.length - 1];
                const transcript = result[0].transcript.trim();
                
                addMessageToChat(`üé§ ${transcript}`, 'user');
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
                processUserInput(transcript);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã
                AppState.speechRecognition.stop();
            };
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
            AppState.speechRecognition.start();
            document.getElementById('modeStatus').textContent = getTranslation('listening');
        }

        function toggleVoiceControl() {
            if (!AppState.apiKey) {
                showNotification(getTranslation('api_key_required'), 'warning');
                return;
            }
            
            AppState.voiceActive = !AppState.voiceActive;
            
            if (AppState.voiceActive) {
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                document.getElementById('micStatus').textContent = getTranslation('mic_enabled');
                document.getElementById('voiceStatus').textContent = getTranslation('active');
                document.getElementById('voiceStatus').className = 'status-value active';
                
                if (!AppState.speechRecognition) {
                    if (!initSpeechRecognition()) {
                        return;
                    }
                }
                
                AppState.speechRecognition.start();
                
            } else {
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                document.getElementById('micStatus').textContent = getTranslation('mic_disabled');
                document.getElementById('voiceStatus').textContent = getTranslation('inactive');
                document.getElementById('voiceStatus').className = 'status-value inactive';
                document.getElementById('micBtn').classList.remove('listening');
                document.getElementById('modeStatus').textContent = getTranslation('waiting');
                
                if (AppState.speechRecognition) {
                    AppState.speechRecognition.stop();
                }
            }
        }

        // ============================================
        // –°–ò–ù–¢–ï–ó –†–ï–ß–ò
        // ============================================
        function speak(text) {
            if (!AppState.speechSynthesis) return;
            
            // –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Ä–µ—á—å
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = AppState.currentLang === 'ru' ? 'ru-RU' : 'en-US';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onstart = () => {
                document.getElementById('modeStatus').textContent = getTranslation('processing');
            };
            
            utterance.onend = () => {
                document.getElementById('modeStatus').textContent = getTranslation('waiting');
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // ============================================
        // –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–ü–†–û–°–û–í –ö AI
        // ============================================
        async function sendToAI(prompt) {
            if (!AppState.apiKey) {
                showNotification(getTranslation('api_key_required'), 'error');
                return null;
            }
            
            AppState.isProcessing = true;
            document.getElementById('modeStatus').textContent = getTranslation('processing');
            
            try {
                // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—Ç–æ–º
                const systemPrompt = AppState.currentLang === 'ru' 
                    ? `–¢—ã —Ä–æ–±–æ—Ç –ü–∏–∫—Å–µ–ª—å. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ (1-2 —Ñ—Ä–∞–∑—ã). 
                       –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –≤–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã LED_ON –∏–ª–∏ LED_OFF.
                       –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å—Ç—Ä–æ–≥–æ: Text: [—Ç–≤–æ–π –æ—Ç–≤–µ—Ç] Commands: [–∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ null]
                       –ü—Ä–∏–º–µ—Ä—ã:
                       - "–í–∫–ª—é—á–∏ —Å–≤–µ—Ç" ‚Üí Text: –í–∫–ª—é—á–∞—é —Å–≤–µ—Ç. Commands: LED_ON
                       - "–í—ã–∫–ª—é—á–∏ —Å–≤–µ—Ç" ‚Üí Text: –í—ã–∫–ª—é—á–∞—é —Å–≤–µ—Ç. Commands: LED_OFF
                       - "–ü—Ä–∏–≤–µ—Ç" ‚Üí Text: –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? Commands: null`
                    : `You are Pixel robot. Answer briefly (1-2 phrases).
                       If the user asks to turn on or off the light, use commands LED_ON or LED_OFF.
                       Response format strictly: Text: [your answer] Commands: [command or null]
                       Examples:
                       - "Turn on the light" ‚Üí Text: Turning on the light. Commands: LED_ON
                       - "Turn off the light" ‚Üí Text: Turning off the light. Commands: LED_OFF
                       - "Hello" ‚Üí Text: Hello! How can I help? Commands: null`;
                
                const requestBody = {
                    model: AppState.selectedModel,
                    messages: [
                        {
                            role: "system",
                            content: systemPrompt
                        },
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    max_tokens: 150,
                    temperature: 0.7
                };
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AppState.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Pixel AI Assistant'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response from AI');
                }
                
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error('AI request error:', error);
                
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞
                if (AppState.retryCount < AppState.maxRetries) {
                    AppState.retryCount++;
                    showNotification(`–ü–æ–ø—ã—Ç–∫–∞ ${AppState.retryCount} –∏–∑ ${AppState.maxRetries}...`, 'warning');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return await sendToAI(prompt);
                }
                
                throw error;
                
            } finally {
                AppState.isProcessing = false;
                AppState.retryCount = 0;
                document.getElementById('modeStatus').textContent = getTranslation('waiting');
            }
        }

        async function processUserInput(input) {
            try {
                addMessageToChat(`ü§ñ ${getTranslation('processing')}...`, 'system');
                
                const aiResponse = await sendToAI(input);
                
                if (!aiResponse) {
                    throw new Error('No response from AI');
                }
                
                // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI
                const textMatch = aiResponse.match(/Text:\s*(.*?)(?:\n|$)/i);
                const commandMatch = aiResponse.match(/Commands:\s*(LED_ON|LED_OFF|null)/i);
                
                const responseText = textMatch ? textMatch[1].trim() : aiResponse;
                const command = commandMatch ? commandMatch[1].toUpperCase() : null;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ —á–∞—Ç
                addMessageToChat(`ü§ñ ${responseText}`, 'ai');
                
                // –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
                speak(responseText);
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É ESP32 –µ—Å–ª–∏ –µ—Å—Ç—å
                if (command && command !== 'NULL' && AppState.espIp) {
                    await sendToESP32(command);
                }
                
            } catch (error) {
                console.error('Error processing input:', error);
                
                const errorMessage = AppState.currentLang === 'ru'
                    ? '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'
                    : 'Sorry, an error occurred. Please try again.';
                
                addMessageToChat(`‚ùå ${errorMessage}`, 'system');
                speak(errorMessage);
                
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI', 'error');
            }
        }

        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï ESP32
        // ============================================
        async function sendToESP32(command) {
            if (!AppState.espIp) return;
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Image –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
                const img = new Image();
                const url = `http://${AppState.espIp}/command?cmd=${encodeURIComponent(command)}&_=${Date.now()}`;
                
                img.onload = () => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞
                    if (command === 'LED_ON') {
                        AppState.ledState = 'on';
                        document.getElementById('ledStatus').textContent = getTranslation('on');
                        document.getElementById('ledStatus').className = 'status-value active';
                    } else if (command === 'LED_OFF') {
                        AppState.ledState = 'off';
                        document.getElementById('ledStatus').textContent = getTranslation('off');
                        document.getElementById('ledStatus').className = 'status-value inactive';
                    }
                    
                    AppState.espConnected = true;
                    document.getElementById('espStatus').textContent = getTranslation('connected');
                    document.getElementById('espStatus').className = 'status-value active';
                    
                    addMessageToChat(`‚ö° ${getTranslation('command_sent')}: ${command}`, 'system');
                };
                
                img.onerror = () => {
                    AppState.espConnected = false;
                    document.getElementById('espStatus').textContent = getTranslation('not_connected');
                    document.getElementById('espStatus').className = 'status-value inactive';
                };
                
                img.src = url;
                
            } catch (error) {
                console.error('Error sending to ESP32:', error);
                AppState.espConnected = false;
                document.getElementById('espStatus').textContent = getTranslation('not_connected');
                document.getElementById('espStatus').className = 'status-value inactive';
            }
        }

        async function testESP32Connection() {
            if (!AppState.espIp) {
                showNotification(getTranslation('esp32_hint'), 'warning');
                return;
            }
            
            try {
                document.getElementById('espStatus').textContent = '...';
                
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                await fetch(`http://${AppState.espIp}/`, {
                    mode: 'no-cors',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                AppState.espConnected = true;
                document.getElementById('espStatus').textContent = getTranslation('connected');
                document.getElementById('espStatus').className = 'status-value active';
                
                showNotification(getTranslation('esp32_connected'), 'success');
                
            } catch (error) {
                AppState.espConnected = false;
                document.getElementById('espStatus').textContent = getTranslation('not_connected');
                document.getElementById('espStatus').className = 'status-value inactive';
                
                showNotification(getTranslation('esp32_disconnected'), 'error');
            }
        }

        // ============================================
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
        // ============================================
        function setupEventListeners() {
            // –í—ã–±–æ—Ä —è–∑—ã–∫–∞
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = btn.dataset.lang;
                    
                    document.querySelectorAll('.lang-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    AppState.currentLang = lang;
                    updateTranslations();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
                    if (AppState.speechRecognition) {
                        AppState.speechRecognition.lang = lang === 'ru' ? 'ru-RU' : 'en-US';
                    }
                    
                    showNotification(`–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${lang.toUpperCase()}`, 'success');
                });
            });
            
            // –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ AI
            document.querySelectorAll('.model-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.model-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    card.classList.add('active');
                    AppState.selectedModel = card.dataset.model;
                    
                    const modelName = card.querySelector('.model-name').textContent;
                    showNotification(`–í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å: ${modelName}`, 'success');
                });
            });
            
            // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // –ö–Ω–æ–ø–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            document.getElementById('micBtn').addEventListener('click', toggleVoiceControl);
            
            // –ö–Ω–æ–ø–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ESP32
            document.getElementById('testESP32').addEventListener('click', testESP32Connection);
            
            // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Å–∏—Å—Ç–µ–º—ã
            document.getElementById('resetSystem').addEventListener('click', () => {
                if (confirm(AppState.currentLang === 'ru' 
                    ? '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å–∏—Å—Ç–µ–º—É?' 
                    : 'Are you sure you want to reset the system?')) {
                    location.reload();
                }
            });
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            sendBtn.addEventListener('click', () => {
                const message = chatInput.value.trim();
                if (message) {
                    addMessageToChat(message, 'user');
                    processUserInput(message);
                    chatInput.value = '';
                    chatInput.style.height = 'auto';
                }
            });
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ IP ESP32
            document.getElementById('espIp').addEventListener('change', function() {
                const ip = this.value.trim();
                localStorage.setItem('pixel_ai_esp_ip', ip);
                document.getElementById('testESP32').disabled = !ip;
            });
            
            // Wake Lock –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if ('wakeLock' in navigator) {
                document.addEventListener('visibilitychange', async () => {
                    if (document.visibilityState === 'visible' && AppState.voiceActive) {
                        try {
                            AppState.wakeLock = await navigator.wakeLock.request('screen');
                        } catch (err) {
                            console.log('Wake Lock failed:', err);
                        }
                    }
                });
            }
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        // ============================================
        function initializeApp() {
            loadSettings();
            setupEventListeners();
            updateTime();
            setInterval(updateTime, 60000);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
            if (!('speechSynthesis' in window)) {
                showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏', 'warning');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            const welcomeMessage = getTranslation('welcome_message');
            document.querySelector('.message.system div').textContent = welcomeMessage;
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>