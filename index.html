<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PIXEL AI: Trinity Edition</title>

<style>
:root { --neon:#ffaa00; --bg:#0a0a0a; }
body { margin:0; background:var(--bg); color:var(--neon); font-family:monospace; height:100vh; display:flex; flex-direction:column; }
#terminal { flex:1; padding:20px; overflow-y:auto; border-bottom:1px solid #222; }
.controls { padding:20px; background:#111; display:flex; flex-direction:column; gap:10px; }
input,button { padding:12px; font-size:16px; }
button { background:var(--neon); border:none; font-weight:bold; }
.sys { color:#00d2ff }
.ai { color:#fff }
.cmd { color:#00ff9d }
.esp-connected { color:#00ff9d }
.esp-disconnected { color:#ff4757 }
</style>
</head>

<body>

<div style="padding:10px;background:#111">
STATUS: <span id="st">READY</span> |
ESP32: <span id="espStatus" class="esp-disconnected">DISCONNECTED</span>
</div>

<div id="terminal"></div>

<div class="controls" id="setup">
<input id="key" placeholder="OpenRouter API Key">
<input id="ip" placeholder="IP ESP32">
<button onclick="boot()">–ó–ê–ü–£–°–¢–ò–¢–¨</button>
</div>

<script>
const term = document.getElementById("terminal");
const st = document.getElementById("st");
const espStatus = document.getElementById("espStatus");

let config = {
  key:"",
  ip:"",
  active:false,
  espConnected:false,
  espPermission:false
};

function log(msg, cls="") {
  const d = document.createElement("div");
  d.className = cls;
  d.innerHTML = "> " + msg;
  term.appendChild(d);
  term.scrollTop = term.scrollHeight;
}

function boot() {
  config.key = key.value.trim();
  config.ip = ip.value.trim();
  if (!config.key) return alert("–ù–µ—Ç API –∫–ª—é—á–∞");

  if (!confirm("–†–∞–∑—Ä–µ—à–∏—Ç—å —Å–∞–π—Ç—É —É–ø—Ä–∞–≤–ª—è—Ç—å ESP32 –≤ –≤–∞—à–µ–π —Å–µ—Ç–∏?")) {
    log("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "sys");
    return;
  }

  config.espPermission = true;
  localStorage.setItem("espPermission","true");

  setup.style.display="none";
  config.active = true;

  log("Trinity –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞", "sys");
  connectToESP32();
}

async function connectToESP32() {
  try {
    const r = await fetch(`http://${config.ip}/ping`);
    const t = await r.text();
    if (t !== "pong") throw 0;

    config.espConnected = true;
    espStatus.textContent = "CONNECTED";
    espStatus.className = "esp-connected";
    log("ESP32 –ø–æ–¥–∫–ª—é—á—ë–Ω", "sys");

  } catch {
    log("ESP32 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "sys");
  }
}

function sendESP32Command(cmd) {
  if (!config.espConnected || !config.espPermission) {
    log("‚õî –ö–æ–º–∞–Ω–¥–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞", "sys");
    return;
  }

  fetch(`http://${config.ip}/command?cmd=${encodeURIComponent(cmd)}`)
    .then(()=>log(`üì§ ${cmd}`, "cmd"))
    .catch(()=>log("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏","sys"));
}

/* ==== –ò–ò ==== */

async function askTrinity(prompt) {
  st.textContent="THINKING";

  const r = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method:"POST",
    headers:{
      "Authorization":`Bearer ${config.key}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      model:"arcee-ai/trinity-large-preview:free",
      messages:[
        { role:"system", content:"–û—Ç–≤–µ—á–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ Text / Commands" },
        { role:"user", content:prompt }
      ]
    })
  });

  const data = await r.json();
  const raw = data.choices[0].message.content;

  const text = raw.match(/Text:\s*(.*)/i)?.[1] || raw;
  const cmds = raw.match(/Commands:\s*(.*)/i)?.[1] || "null";

  log("PIXEL: "+text,"ai");

  if (cmds.toUpperCase() !== "NULL") {
    cmds.split(",").forEach(c=>sendESP32Command(c.trim()));
  }
}
</script>
</body>
</html>
