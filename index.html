<!DOCTYPE html>
<html lang="ru" id="htmlLang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL TERMINAL | AI Assistant</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0e14">
    <style>
        :root {
            --neon-primary: #00ff9d;
            --neon-secondary: #0094ff;
            --neon-accent: #ff00e5;
            --neon-warning: #ff4757;
            --bg-primary: #0a0e14;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #252a3a;
            --text-primary: #ffffff;
            --text-secondary: #b0b7c3;
            --card-bg: rgba(26, 31, 46, 0.8);
            --border-color: rgba(0, 255, 157, 0.2);
            --shadow-glow: 0 0 20px rgba(0, 255, 157, 0.3);
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'SF Mono', 'Cascadia Code', 'Monaco', monospace;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 255, 157, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 148, 255, 0.05) 0%, transparent 50%);
        }

        /* Glassmorphism —ç—Ñ—Ñ–µ–∫—Ç—ã */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
        }

        /* Header */
        .header {
            padding: 15px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10, 14, 20, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
            border-radius: 6px;
            position: relative;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .logo-text {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--neon-primary), var(--neon-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Language Selector */
        .language-selector {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--border-color);
        }

        .lang-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 60px;
            text-align: center;
        }

        .lang-btn.active {
            background: var(--neon-primary);
            color: var(--bg-primary);
            box-shadow: var(--shadow-glow);
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* Terminal Section */
        .terminal-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .terminal-card {
            flex: 1;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .terminal-controls {
            display: flex;
            gap: 8px;
        }

        .terminal-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--neon-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .terminal-btn:hover {
            background: var(--neon-primary);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }

        #terminal {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 12px 12px;
        }

        /* Terminal Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
            max-width: 90%;
            word-wrap: break-word;
            position: relative;
        }

        .message.system {
            background: rgba(0, 255, 157, 0.1);
            border-left: 3px solid var(--neon-primary);
            align-self: flex-start;
        }

        .message.ai {
            background: rgba(0, 148, 255, 0.1);
            border-left: 3px solid var(--neon-secondary);
            align-self: flex-start;
        }

        .message.user {
            background: rgba(255, 0, 229, 0.1);
            border-left: 3px solid var(--neon-accent);
            align-self: flex-end;
        }

        .message.error {
            background: rgba(255, 71, 87, 0.1);
            border-left: 3px solid var(--neon-warning);
            align-self: flex-start;
        }

        .message-timestamp {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: block;
        }

        /* Controls Section */
        .controls-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .status-card, .config-card, .voice-card, .input-card {
            padding: 20px;
        }

        .card-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--neon-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title::before {
            content: '‚ü©';
            color: var(--neon-primary);
        }

        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .status-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .status-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neon-warning);
            box-shadow: 0 0 8px currentColor;
        }

        .status-indicator.online {
            background: var(--neon-primary);
            box-shadow: 0 0 8px var(--neon-primary);
        }

        .status-indicator.offline {
            background: var(--neon-warning);
            box-shadow: 0 0 8px var(--neon-warning);
        }

        .status-indicator.pending {
            background: #ffa500;
            box-shadow: 0 0 8px #ffa500;
            animation: pulse 1.5s infinite;
        }

        /* Connection Status */
        .connection-status {
            margin-top: 16px;
            padding: 12px;
            background: rgba(0, 255, 157, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .connection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .connection-item:last-child {
            border-bottom: none;
        }

        /* Input Groups */
        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--neon-primary);
            box-shadow: var(--shadow-glow);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            line-height: 1.5;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
            color: var(--bg-primary);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .btn-secondary {
            background: transparent;
            color: var(--neon-primary);
            border: 1px solid var(--neon-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--neon-primary);
            color: var(--bg-primary);
        }

        .btn-danger {
            background: transparent;
            color: var(--neon-warning);
            border: 1px solid var(--neon-warning);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--neon-warning);
            color: var(--bg-primary);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Voice Control */
        .voice-control {
            text-align: center;
        }

        .voice-status {
            margin: 20px 0;
            padding: 16px;
            background: rgba(0, 255, 157, 0.05);
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .voice-status.active {
            border-color: var(--neon-primary);
            box-shadow: 0 0 30px rgba(0, 255, 157, 0.2);
        }

        .voice-visualizer {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            margin: 20px 0;
        }

        .voice-bar {
            width: 4px;
            background: var(--neon-primary);
            border-radius: 2px;
            animation: voicePulse 0.8s ease infinite alternate;
        }

        .activation-phrase-display {
            margin-top: 16px;
            padding: 12px;
            background: rgba(255, 0, 229, 0.1);
            border-radius: 8px;
            border: 1px solid var(--neon-accent);
        }

        .activation-phrases-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .phrase-tag {
            padding: 6px 12px;
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid var(--neon-primary);
            border-radius: 6px;
            font-size: 12px;
            color: var(--neon-primary);
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--neon-primary);
            color: var(--bg-primary);
            box-shadow: var(--shadow-glow);
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes voicePulse {
            0% {
                height: 5px;
                opacity: 0.3;
            }
            100% {
                height: 30px;
                opacity: 1;
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px var(--neon-primary);
            }
            50% {
                box-shadow: 0 0 20px var(--neon-primary);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 16px;
                gap: 16px;
            }

            .header {
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                padding: 12px 16px;
            }

            .message {
                max-width: 100%;
            }
        }

        /* Connection Test Animation */
        .testing {
            animation: pulse 1s infinite;
        }

        /* Wake Lock Status */
        .wake-lock-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid var(--neon-primary);
            border-radius: 6px;
            font-size: 11px;
            color: var(--neon-primary);
            z-index: 1000;
            display: none;
        }

        .wake-lock-status.active {
            display: block;
            animation: glow 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Wake Lock Status Indicator -->
    <div class="wake-lock-status" id="wakeLockStatus">
        üîí WAKE LOCK ACTIVE
    </div>

    <!-- Header -->
    <header class="header glass-panel">
        <div class="logo-container">
            <div class="logo-icon"></div>
            <div class="logo-text" id="logoText">NEURAL TERMINAL v3.2</div>
        </div>
        
        <div class="header-controls">
            <div class="language-selector">
                <button class="lang-btn active" onclick="setLanguage('ru')" id="langRu">RU</button>
                <button class="lang-btn" onclick="setLanguage('en')" id="langEn">EN</button>
            </div>
            
            <div class="status-indicator online" id="globalStatus"></div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Terminal Section -->
        <section class="terminal-section">
            <div class="terminal-card glass-panel">
                <div class="terminal-header">
                    <div class="terminal-title">
                        <span id="terminalTitle">–ö–û–ù–°–û–õ–¨ –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø</span>
                    </div>
                    <div class="terminal-controls">
                        <button class="terminal-btn" onclick="clearTerminal()" title="–û—á–∏—Å—Ç–∏—Ç—å">‚å´</button>
                        <button class="terminal-btn" onclick="exportLogs()" title="–≠–∫—Å–ø–æ—Ä—Ç">‚§ì</button>
                    </div>
                </div>
                
                <div id="terminal">
                    <div class="message system">
                        <span id="welcomeMessage">–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.</span>
                        <span class="message-timestamp" id="currentTime"></span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Controls Section -->
        <section class="controls-section">
            <!-- Status Card -->
            <div class="status-card glass-panel">
                <div class="card-title" id="statusTitle">–°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´</div>
                
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label" id="aiStatusLabel">AI</div>
                        <div class="status-value">
                            <span class="status-indicator offline" id="aiStatusIndicator"></span>
                            <span id="aiStatusText">OFFLINE</span>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label" id="voiceStatusLabel">–ì–û–õ–û–°</div>
                        <div class="status-value">
                            <span class="status-indicator offline" id="voiceStatusIndicator"></span>
                            <span id="voiceStatusText">DISABLED</span>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label" id="espStatusLabel">ESP32</div>
                        <div class="status-value">
                            <span class="status-indicator offline" id="espStatusIndicator"></span>
                            <span id="espStatusText">NOT CONNECTED</span>
                        </div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label" id="memoryStatusLabel">–ü–ê–ú–Ø–¢–¨</div>
                        <div class="status-value" id="memoryStatusText">0%</div>
                    </div>
                </div>
                
                <div class="connection-status">
                    <div class="connection-item">
                        <span id="connectionLabel">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ESP32:</span>
                        <span class="status-value">
                            <span class="status-indicator offline" id="espConnectionIndicator"></span>
                            <span id="espConnectionText">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                        </span>
                    </div>
                    <div class="connection-item">
                        <span id="lastPingLabel">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–∏–Ω–≥:</span>
                        <span id="lastPingText">-</span>
                    </div>
                </div>
            </div>

            <!-- Mode Selection Card -->
            <div class="config-card glass-panel">
                <div class="card-title" id="modeTitle">–†–ï–ñ–ò–ú –†–ê–ë–û–¢–´</div>
                
                <div class="mode-selector">
                    <button class="mode-btn active" onclick="setMode('voice')" id="modeVoice">
                        <span>üé§</span>
                        <span id="modeVoiceText">–ì–û–õ–û–°</span>
                    </button>
                    <button class="mode-btn" onclick="setMode('text')" id="modeTextBtn">
                        <span>‚å®Ô∏è</span>
                        <span id="modeTextText">–¢–ï–ö–°–¢</span>
                    </button>
                    <button class="mode-btn" onclick="setMode('hybrid')" id="modeHybrid">
                        <span>üîÄ</span>
                        <span id="modeHybridText">–ì–ò–ë–†–ò–î</span>
                    </button>
                </div>
            </div>

            <!-- Voice Control Card -->
            <div class="voice-card glass-panel" id="voiceCard">
                <div class="card-title" id="voiceControlTitle">–ì–û–õ–û–°–û–í–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
                
                <div class="voice-control">
                    <div class="voice-status" id="voiceStatusDisplay">
                        <div id="voiceStatusMessage">–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ</div>
                    </div>
                    
                    <div class="voice-visualizer" id="voiceVisualizer"></div>
                    
                    <div class="activation-phrase-display">
                        <div class="input-label" id="activationLabel">–ê–ö–¢–ò–í–ê–¶–ò–û–ù–ù–´–ï –§–†–ê–ó–´:</div>
                        <div class="activation-phrases-container">
                            <span class="phrase-tag">–ø–∏–∫—Å–µ–ª—å</span>
                            <span class="phrase-tag">pixel</span>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-primary" onclick="toggleVoiceControl()" id="voiceToggleBtn">
                            <span>üé§</span>
                            <span id="voiceToggleText">–í–ö–õ–Æ–ß–ò–¢–¨ –ì–û–õ–û–°</span>
                        </button>
                        <button class="btn-secondary" onclick="testMicrophone()" id="testMicBtn">
                            <span>üéß</span>
                            <span id="testMicText">–¢–ï–°–¢ –ú–ò–ö–†–û–§–û–ù–ê</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Text Input Card -->
            <div class="input-card glass-panel" id="textInputCard" style="display: none;">
                <div class="card-title" id="textInputTitle">–¢–ï–ö–°–¢–û–í–´–ô –í–í–û–î</div>
                
                <div class="input-group">
                    <textarea id="textInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å –∑–¥–µ—Å—å..." rows="4"></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="sendTextRequest()" id="sendTextBtn">
                        <span>üöÄ</span>
                        <span id="sendTextText">–û–¢–ü–†–ê–í–ò–¢–¨</span>
                    </button>
                    <button class="btn-secondary" onclick="clearTextInput()">
                        <span>‚å´</span>
                        <span id="clearTextText">–û–ß–ò–°–¢–ò–¢–¨</span>
                    </button>
                </div>
            </div>

            <!-- Configuration Card -->
            <div class="config-card glass-panel">
                <div class="card-title" id="configTitle">–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø</div>
                
                <div class="input-group">
                    <label class="input-label" for="apiKey">OPENROUTER API KEY</label>
                    <input type="password" id="apiKey" placeholder="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                
                <div class="input-group">
                    <label class="input-label" for="espIp">ESP32 IP –ê–î–†–ï–°</label>
                    <input type="text" id="espIp" placeholder="192.168.1.100">
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="initializeSystem()" id="initBtn">
                        <span>‚ö°</span>
                        <span id="initText">–ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨</span>
                    </button>
                    <button class="btn-secondary" onclick="testConnections()" id="testBtn" disabled>
                        <span>üîß</span>
                        <span id="testText">–¢–ï–°–¢ –°–ò–°–¢–ï–ú–´</span>
                    </button>
                    <button class="btn-danger" onclick="resetSystem()" id="resetBtn">
                        <span>üîÑ</span>
                        <span id="resetText">–°–ë–†–û–°</span>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–°–¢–ê–ù–¢–´
        // ============================================
        const SystemState = {
            // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            apiKey: '',
            espIp: '',
            language: 'ru',
            mode: 'voice',
            
            // –ê–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–æ–∏—Ö —è–∑—ã–∫–æ–≤)
            activationPhrases: ['–ø–∏–∫—Å–µ–ª—å', 'pixel'],
            
            // –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
            systemActive: false,
            voiceEnabled: false,
            listeningForActivation: false,
            listeningForCommand: false,
            isProcessing: false,
            isSpeaking: false,
            microphoneGranted: false,
            
            // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã
            wakeLock: null,
            speechRecognition: null,
            speechSynthesis: window.speechSynthesis,
            visualizerInterval: null,
            connectionMonitor: null,
            microphoneStream: null,
            
            // –°—á–µ—Ç—á–∏–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
            retryCount: 0,
            maxRetries: 3,
            logEntries: 0,
            maxLogEntries: 200,
            lastCommandTime: 0,
            commandCooldown: 1500,
            lastESP32Ping: 0,
            
            // –Ø–∑—ã–∫–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã (–ü–û–õ–ù–´–ô –ü–ï–†–ï–í–û–î)
            translations: {
                ru: {
                    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    terminalTitle: '–ö–û–ù–°–û–õ–¨ –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø',
                    statusTitle: '–°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´',
                    modeTitle: '–†–ï–ñ–ò–ú –†–ê–ë–û–¢–´',
                    voiceControlTitle: '–ì–û–õ–û–°–û–í–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï',
                    textInputTitle: '–¢–ï–ö–°–¢–û–í–´–ô –í–í–û–î',
                    configTitle: '–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø',
                    logoText: 'NEURAL TERMINAL v3.2',
                    
                    // –ö–Ω–æ–ø–∫–∏
                    initText: '–ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨',
                    testText: '–¢–ï–°–¢ –°–ò–°–¢–ï–ú–´',
                    resetText: '–°–ë–†–û–°',
                    voiceToggleText: '–í–ö–õ–Æ–ß–ò–¢–¨ –ì–û–õ–û–°',
                    voiceToggleOffText: '–í–´–ö–õ–Æ–ß–ò–¢–¨ –ì–û–õ–û–°',
                    testMicText: '–¢–ï–°–¢ –ú–ò–ö–†–û–§–û–ù–ê',
                    sendTextText: '–û–¢–ü–†–ê–í–ò–¢–¨',
                    clearTextText: '–û–ß–ò–°–¢–ò–¢–¨',
                    
                    // –†–µ–∂–∏–º—ã
                    modeVoiceText: '–ì–û–õ–û–°',
                    modeTextText: '–¢–ï–ö–°–¢',
                    modeHybridText: '–ì–ò–ë–†–ò–î',
                    
                    // –°—Ç–∞—Ç—É—Å—ã
                    aiStatusLabel: 'AI',
                    voiceStatusLabel: '–ì–û–õ–û–°',
                    espStatusLabel: 'ESP32',
                    memoryStatusLabel: '–ü–ê–ú–Ø–¢–¨',
                    connectionLabel: '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ESP32:',
                    lastPingLabel: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–∏–Ω–≥:',
                    activationLabel: '–ê–ö–¢–ò–í–ê–¶–ò–û–ù–ù–´–ï –§–†–ê–ó–´:',
                    
                    // –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
                    aiStatusOnline: 'ONLINE',
                    aiStatusOffline: 'OFFLINE',
                    voiceStatusActive: 'ACTIVE',
                    voiceStatusDisabled: 'DISABLED',
                    voiceStatusListening: 'LISTENING',
                    espStatusConfigured: 'CONFIGURED',
                    espStatusNotConfigured: 'NOT CONFIGURED',
                    espStatusConnected: 'CONNECTED',
                    espStatusDisconnected: 'DISCONNECTED',
                    
                    // –°–æ–æ–±—â–µ–Ω–∏—è
                    welcomeMessage: '–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.',
                    systemInitialized: '–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞',
                    voiceControlEnabled: '–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ',
                    voiceControlDisabled: '–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ',
                    microphoneTestSuccess: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ',
                    microphoneTestFail: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É',
                    systemTestStarted: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...',
                    systemTestComplete: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ',
                    systemReset: '–°–∏—Å—Ç–µ–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞',
                    
                    // –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    voiceStatusMessages: {
                        disabled: '–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ',
                        waiting: '–û–∂–∏–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–π —Ñ—Ä–∞–∑—ã...',
                        listening: '–°–ª—É—à–∞—é –∫–æ–º–∞–Ω–¥—É...',
                        processing: '–û–±—Ä–∞–±–æ—Ç–∫–∞...',
                        speaking: '–û—Ç–≤–µ—á–∞—é...'
                    },
                    
                    // –û—Ç–≤–µ—Ç—ã –≥–æ–ª–æ—Å–æ–º
                    activationResponse: "–î–∞, —Å–ª—É—à–∞—é –≤–∞—Å!",
                    errorResponse: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞",
                    
                    // –ü–æ–¥—Å–∫–∞–∑–∫–∏
                    apiKeyPlaceholder: 'sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxx',
                    espIpPlaceholder: '192.168.1.100',
                    textInputPlaceholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å –∑–¥–µ—Å—å...'
                },
                en: {
                    // Interface
                    terminalTitle: 'INTERACTION CONSOLE',
                    statusTitle: 'SYSTEM STATUS',
                    modeTitle: 'OPERATION MODE',
                    voiceControlTitle: 'VOICE CONTROL',
                    textInputTitle: 'TEXT INPUT',
                    configTitle: 'CONFIGURATION',
                    logoText: 'NEURAL TERMINAL v3.2',
                    
                    // Buttons
                    initText: 'INITIALIZE',
                    testText: 'TEST SYSTEM',
                    resetText: 'RESET',
                    voiceToggleText: 'ENABLE VOICE',
                    voiceToggleOffText: 'DISABLE VOICE',
                    testMicText: 'TEST MIC',
                    sendTextText: 'SEND',
                    clearTextText: 'CLEAR',
                    
                    // Modes
                    modeVoiceText: 'VOICE',
                    modeTextText: 'TEXT',
                    modeHybridText: 'HYBRID',
                    
                    // Statuses
                    aiStatusLabel: 'AI',
                    voiceStatusLabel: 'VOICE',
                    espStatusLabel: 'ESP32',
                    memoryStatusLabel: 'MEMORY',
                    connectionLabel: 'ESP32 Connection:',
                    lastPingLabel: 'Last ping:',
                    activationLabel: 'ACTIVATION PHRASES:',
                    
                    // Status texts
                    aiStatusOnline: 'ONLINE',
                    aiStatusOffline: 'OFFLINE',
                    voiceStatusActive: 'ACTIVE',
                    voiceStatusDisabled: 'DISABLED',
                    voiceStatusListening: 'LISTENING',
                    espStatusConfigured: 'CONFIGURED',
                    espStatusNotConfigured: 'NOT CONFIGURED',
                    espStatusConnected: 'CONNECTED',
                    espStatusDisconnected: 'DISCONNECTED',
                    
                    // Messages
                    welcomeMessage: 'System initialized. Enter API key to start.',
                    systemInitialized: 'System initialized',
                    voiceControlEnabled: 'Voice control enabled',
                    voiceControlDisabled: 'Voice control disabled',
                    microphoneTestSuccess: 'Microphone working normally',
                    microphoneTestFail: 'Failed to access microphone',
                    systemTestStarted: 'Testing system...',
                    systemTestComplete: 'Testing complete',
                    systemReset: 'System reset',
                    
                    // Voice messages
                    voiceStatusMessages: {
                        disabled: 'Voice control disabled',
                        waiting: 'Waiting for activation phrase...',
                        listening: 'Listening for command...',
                        processing: 'Processing...',
                        speaking: 'Speaking...'
                    },
                    
                    // Voice responses
                    activationResponse: "Yes, I'm listening!",
                    errorResponse: "An error occurred while processing the request",
                    
                    // Placeholders
                    apiKeyPlaceholder: 'sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxx',
                    espIpPlaceholder: '192.168.1.100',
                    textInputPlaceholder: 'Enter your query here...'
                }
            }
        };

        // ============================================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –°–ò–°–¢–ï–ú–´
        // ============================================
        function logToTerminal(message, type = 'system') {
            const terminal = document.getElementById('terminal');
            const messageDiv = document.createElement('div');
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                ${message}
                <span class="message-timestamp">${timestamp}</span>
            `;
            
            terminal.appendChild(messageDiv);
            terminal.scrollTop = terminal.scrollHeight;
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
            SystemState.logEntries++;
            updateMemoryStatus();
            
            if (SystemState.logEntries > SystemState.maxLogEntries) {
                const firstMessage = terminal.querySelector('.message');
                if (firstMessage) {
                    terminal.removeChild(firstMessage);
                    SystemState.logEntries--;
                }
            }
        }

        function updateMemoryStatus() {
            const percent = Math.min(100, Math.round((SystemState.logEntries / SystemState.maxLogEntries) * 100));
            document.getElementById('memoryStatusText').textContent = `${percent}%`;
        }

        function updateStatusDisplay() {
            // AI Status
            const aiIndicator = document.getElementById('aiStatusIndicator');
            const aiText = document.getElementById('aiStatusText');
            aiIndicator.className = SystemState.systemActive ? 'status-indicator online' : 'status-indicator offline';
            aiText.textContent = SystemState.systemActive ? 
                SystemState.translations[SystemState.language].aiStatusOnline : 
                SystemState.translations[SystemState.language].aiStatusOffline;
            
            // Voice Status
            const voiceIndicator = document.getElementById('voiceStatusIndicator');
            const voiceText = document.getElementById('voiceStatusText');
            if (SystemState.voiceEnabled) {
                voiceIndicator.className = SystemState.listeningForCommand ? 'status-indicator pending' : 'status-indicator online';
                voiceText.textContent = SystemState.listeningForCommand ? 
                    SystemState.translations[SystemState.language].voiceStatusListening : 
                    SystemState.translations[SystemState.language].voiceStatusActive;
            } else {
                voiceIndicator.className = 'status-indicator offline';
                voiceText.textContent = SystemState.translations[SystemState.language].voiceStatusDisabled;
            }
            
            // ESP32 Status
            const espIndicator = document.getElementById('espStatusIndicator');
            const espText = document.getElementById('espStatusText');
            espIndicator.className = SystemState.espIp ? 'status-indicator pending' : 'status-indicator offline';
            espText.textContent = SystemState.espIp ? 
                SystemState.translations[SystemState.language].espStatusConfigured : 
                SystemState.translations[SystemState.language].espStatusNotConfigured;
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            const globalStatus = document.getElementById('globalStatus');
            if (SystemState.voiceEnabled && SystemState.listeningForCommand) {
                globalStatus.className = 'status-indicator pending';
            } else if (SystemState.systemActive) {
                globalStatus.className = 'status-indicator online';
            } else {
                globalStatus.className = 'status-indicator offline';
            }
        }

        function updateVoiceStatus(messageKey) {
            const voiceStatus = document.getElementById('voiceStatusDisplay');
            const voiceMessage = document.getElementById('voiceStatusMessage');
            
            const messages = SystemState.translations[SystemState.language].voiceStatusMessages;
            voiceMessage.textContent = messages[messageKey] || messageKey;
            
            voiceStatus.className = 'voice-status';
            if (messageKey === 'waiting' || messageKey === 'listening') {
                voiceStatus.classList.add('active');
            }
        }

        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –Ø–ó–´–ö–û–ú (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï)
        // ============================================
        function setLanguage(lang) {
            SystemState.language = lang;
            document.getElementById('htmlLang').lang = lang;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
            document.getElementById('langRu').classList.toggle('active', lang === 'ru');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã
            updateInterfaceLanguage();
            
            // –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
            if (SystemState.systemActive && SystemState.voiceEnabled && SystemState.speechRecognition) {
                restartSpeechRecognition();
            }
            
            logToTerminal(lang === 'ru' ? '–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ –†—É—Å—Å–∫–∏–π' : 'Language changed to English', 'system');
        }

        function restartSpeechRecognition() {
            if (SystemState.speechRecognition) {
                SystemState.speechRecognition.stop();
                setTimeout(() => {
                    initSpeechRecognition();
                    if (SystemState.voiceEnabled) {
                        SystemState.speechRecognition.start();
                    }
                }, 300);
            }
        }

        function updateInterfaceLanguage() {
            const t = SystemState.translations[SystemState.language];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            document.getElementById('terminalTitle').textContent = t.terminalTitle;
            document.getElementById('statusTitle').textContent = t.statusTitle;
            document.getElementById('modeTitle').textContent = t.modeTitle;
            document.getElementById('voiceControlTitle').textContent = t.voiceControlTitle;
            document.getElementById('textInputTitle').textContent = t.textInputTitle;
            document.getElementById('configTitle').textContent = t.configTitle;
            document.getElementById('logoText').textContent = t.logoText;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('initText').textContent = t.initText;
            document.getElementById('testText').textContent = t.testText;
            document.getElementById('resetText').textContent = t.resetText;
            document.getElementById('testMicText').textContent = t.testMicText;
            document.getElementById('sendTextText').textContent = t.sendTextText;
            document.getElementById('clearTextText').textContent = t.clearTextText;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');
            if (SystemState.voiceEnabled) {
                voiceToggleBtn.querySelector('span:nth-child(2)').textContent = t.voiceToggleOffText;
            } else {
                voiceToggleBtn.querySelector('span:nth-child(2)').textContent = t.voiceToggleText;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–∏–º—ã
            document.getElementById('modeVoiceText').textContent = t.modeVoiceText;
            document.getElementById('modeTextText').textContent = t.modeTextText;
            document.getElementById('modeHybridText').textContent = t.modeHybridText;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
            document.getElementById('aiStatusLabel').textContent = t.aiStatusLabel;
            document.getElementById('voiceStatusLabel').textContent = t.voiceStatusLabel;
            document.getElementById('espStatusLabel').textContent = t.espStatusLabel;
            document.getElementById('memoryStatusLabel').textContent = t.memoryStatusLabel;
            document.getElementById('connectionLabel').textContent = t.connectionLabel;
            document.getElementById('lastPingLabel').textContent = t.lastPingLabel;
            document.getElementById('activationLabel').textContent = t.activationLabel;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
            document.getElementById('textInput').placeholder = t.textInputPlaceholder;
            document.getElementById('apiKey').placeholder = t.apiKeyPlaceholder;
            document.getElementById('espIp').placeholder = t.espIpPlaceholder;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('welcomeMessage').textContent = t.welcomeMessage;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (SystemState.voiceEnabled) {
                if (SystemState.listeningForCommand) {
                    updateVoiceStatus('listening');
                } else {
                    updateVoiceStatus('waiting');
                }
            } else {
                updateVoiceStatus('disabled');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã —Å–∏—Å—Ç–µ–º—ã
            updateStatusDisplay();
        }

        // ============================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê–ú–ò
        // ============================================
        function setMode(mode) {
            SystemState.mode = mode;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–æ–≤
            document.getElementById('modeVoice').classList.toggle('active', mode === 'voice');
            document.getElementById('modeTextBtn').classList.toggle('active', mode === 'text');
            document.getElementById('modeHybrid').classList.toggle('active', mode === 'hybrid');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞–Ω–µ–ª–∏
            const voiceCard = document.getElementById('voiceCard');
            const textInputCard = document.getElementById('textInputCard');
            
            if (mode === 'voice') {
                voiceCard.style.display = 'block';
                textInputCard.style.display = 'none';
            } else if (mode === 'text') {
                voiceCard.style.display = 'none';
                textInputCard.style.display = 'block';
            } else {
                voiceCard.style.display = 'block';
                textInputCard.style.display = 'block';
            }
            
            const modeText = mode === 'ru' ? mode.toUpperCase() : 
                           mode === 'voice' ? '–ì–û–õ–û–°' : 
                           mode === 'text' ? '–¢–ï–ö–°–¢' : '–ì–ò–ë–†–ò–î';
            logToTerminal(`–†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω: ${modeText}`, 'system');
        }

        // ============================================
        // –ì–û–õ–û–°–û–í–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï)
        // ============================================
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                logToTerminal('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏', 'error');
                return false;
            }
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                SystemState.speechRecognition = new SpeechRecognition();
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
                SystemState.speechRecognition.continuous = true;
                SystemState.speechRecognition.interimResults = false;
                SystemState.speechRecognition.lang = SystemState.language === 'ru' ? 'ru-RU' : 'en-US';
                SystemState.speechRecognition.maxAlternatives = 1;
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                SystemState.speechRecognition.onaudiostart = () => {
                    console.log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                };
                
                SystemState.speechRecognition.onsoundstart = () => {
                    console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–≤—É–∫');
                };
                
                SystemState.speechRecognition.onspeechstart = () => {
                    console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ä–µ—á—å');
                };
                
                SystemState.speechRecognition.onstart = () => {
                    logToTerminal('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ', 'system');
                    SystemState.listeningForActivation = true;
                    updateVoiceStatus('waiting');
                    updateVisualizer();
                };
                
                SystemState.speechRecognition.onresult = (event) => {
                    const result = event.results[event.results.length - 1];
                    const transcript = result[0].transcript.toLowerCase().trim();
                    const confidence = result[0].confidence;
                    
                    console.log(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}" (${(confidence * 100).toFixed(1)}%)`);
                    logToTerminal(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}"`, 'user');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã (–æ–±–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —è–∑—ã–∫–∞)
                    if (SystemState.listeningForActivation) {
                        const isActivationPhrase = SystemState.activationPhrases.some(phrase => 
                            transcript.includes(phrase.toLowerCase())
                        );
                        
                        if (isActivationPhrase) {
                            handleActivation();
                        }
                    } 
                    // –ï—Å–ª–∏ —Å–ª—É—à–∞–µ–º –∫–æ–º–∞–Ω–¥—É
                    else if (SystemState.listeningForCommand) {
                        handleVoiceCommand(transcript);
                    }
                };
                
                SystemState.speechRecognition.onerror = (event) => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º "—Ç–∏—Ö–∏–µ" –æ—à–∏–±–∫–∏
                    if (event.error === 'no-speech' || event.error === 'audio-capture') {
                        return;
                    }
                    
                    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
                    logToTerminal(`–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${event.error}`, 'error');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
                    if (SystemState.voiceEnabled && SystemState.retryCount < SystemState.maxRetries) {
                        SystemState.retryCount++;
                        setTimeout(() => {
                            if (SystemState.voiceEnabled) {
                                SystemState.speechRecognition.start();
                            }
                        }, 1000);
                    }
                };
                
                SystemState.speechRecognition.onend = () => {
                    console.log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    if (SystemState.voiceEnabled && SystemState.systemActive && !SystemState.isProcessing) {
                        setTimeout(() => {
                            if (SystemState.voiceEnabled) {
                                SystemState.speechRecognition.start();
                            }
                        }, 500);
                    }
                };
                
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                logToTerminal(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                return false;
            }
        }

        async function requestMicrophonePermission() {
            if (SystemState.microphoneGranted) {
                return true;
            }
            
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('API –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                }
                
                SystemState.microphoneStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                SystemState.microphoneGranted = true;
                logToTerminal('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω–æ', 'system');
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                logToTerminal('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
                return false;
            }
        }

        function handleActivation() {
            logToTerminal('‚úì –ê–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞', 'system');
            
            SystemState.listeningForActivation = false;
            SystemState.listeningForCommand = true;
            
            updateVoiceStatus('listening');
            
            // –†–æ–±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–º —è–∑—ã–∫–µ
            const response = SystemState.translations[SystemState.language].activationResponse;
            speakText(response, true);
        }

        function handleVoiceCommand(transcript) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω
            const now = Date.now();
            if (now - SystemState.lastCommandTime < SystemState.commandCooldown) {
                return;
            }
            
            SystemState.lastCommandTime = now;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            if (SystemState.speechRecognition) {
                SystemState.speechRecognition.stop();
            }
            
            SystemState.listeningForCommand = false;
            SystemState.isProcessing = true;
            
            updateVoiceStatus('processing');
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
            processAIRequest(transcript);
        }

        // ============================================
        // –û–ë–†–ê–ë–û–¢–ö–ê AI –ó–ê–ü–†–û–°–û–í (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –Ø–ó–´–ö)
        // ============================================
        async function processAIRequest(prompt) {
            try {
                logToTerminal('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI...', 'system');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞
                const systemMessage = SystemState.language === 'ru' 
                    ? '–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ü–∏–∫—Å–µ–ª—å. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.'
                    : 'You are Pixel assistant. Respond briefly and friendly in English. Do not use commands, only text responses. Respond ONLY in English.';
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SystemState.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Neural Terminal'
                    },
                    body: JSON.stringify({
                        model: SystemState.language === 'ru' ? 'deepseek/deepseek-r1' : 'mistralai/mixtral-8x7b-instruct',
                        messages: [
                            {
                                role: 'system',
                                content: systemMessage
                            },
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                // –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞
                const cleanResponse = aiResponse
                    .replace(/Commands?:\s*\[.*?\]/gi, '')
                    .replace(/Text:\s*/gi, '')
                    .trim();
                
                logToTerminal(`AI: ${cleanResponse}`, 'ai');
                
                // –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
                updateVoiceStatus('speaking');
                speakText(cleanResponse, false);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ AI:', error);
                logToTerminal(`–û—à–∏–±–∫–∞ AI: ${error.message}`, 'error');
                const errorMsg = SystemState.translations[SystemState.language].errorResponse;
                speakText(errorMsg, false);
            }
        }

        function sendTextRequest() {
            const textInput = document.getElementById('textInput');
            const prompt = textInput.value.trim();
            
            if (!prompt) {
                logToTerminal('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞', 'error');
                return;
            }
            
            logToTerminal(`–¢–µ–∫—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞: "${prompt}"`, 'user');
            textInput.value = '';
            
            SystemState.isProcessing = true;
            processAIRequest(prompt);
        }

        // ============================================
        // –°–ò–ù–¢–ï–ó –†–ï–ß–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –Ø–ó–´–ö)
        // ============================================
        function speakText(text, isActivationResponse = false) {
            if (!SystemState.speechSynthesis) return;
            
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = SystemState.language === 'ru' ? 'ru-RU' : 'en-US';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onstart = () => {
                SystemState.isSpeaking = true;
                updateVisualizer();
            };
            
            utterance.onend = () => {
                SystemState.isSpeaking = false;
                SystemState.isProcessing = false;
                
                if (isActivationResponse) {
                    // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
                    SystemState.listeningForCommand = true;
                    updateVoiceStatus('listening');
                    if (SystemState.speechRecognition) {
                        SystemState.speechRecognition.start();
                    }
                } else {
                    // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ–∂–∏–¥–∞–Ω–∏—é –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    setTimeout(() => {
                        SystemState.listeningForActivation = true;
                        SystemState.listeningForCommand = false;
                        updateVoiceStatus('waiting');
                        if (SystemState.speechRecognition && SystemState.voiceEnabled) {
                            SystemState.speechRecognition.start();
                        }
                    }, 1000);
                }
            };
            
            utterance.onerror = (event) => {
                console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏:', event);
                SystemState.isSpeaking = false;
                SystemState.isProcessing = false;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                setTimeout(() => {
                    SystemState.listeningForActivation = true;
                    SystemState.listeningForCommand = false;
                    updateVoiceStatus('waiting');
                    if (SystemState.speechRecognition && SystemState.voiceEnabled) {
                        SystemState.speechRecognition.start();
                    }
                }, 500);
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // ============================================
        // –í–ò–ó–£–ê–õ–ò–ó–ê–¢–û–† –ì–û–õ–û–°–ê
        // ============================================
        function updateVisualizer() {
            const visualizer = document.getElementById('voiceVisualizer');
            const isActive = SystemState.listeningForActivation || SystemState.listeningForCommand || SystemState.isSpeaking;
            const barCount = SystemState.isSpeaking ? 40 : 20;
            
            if (!isActive) {
                visualizer.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 0; i < barCount; i++) {
                const height = SystemState.isSpeaking 
                    ? Math.floor(Math.random() * 40 + 10)
                    : Math.floor(Math.random() * 20 + 5);
                const delay = i * (SystemState.isSpeaking ? 0.03 : 0.05);
                const opacity = 0.3 + Math.random() * 0.7;
                html += `<div class="voice-bar" style="height:${height}px;opacity:${opacity};animation-delay:${delay}s"></div>`;
            }
            
            visualizer.innerHTML = html;
        }

        // ============================================
        // –ó–ê–©–ò–¢–ê –û–¢ –ó–ê–°–´–ü–ê–ù–ò–Ø (WAKE LOCK)
        // ============================================
        async function enableWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    SystemState.wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('wakeLockStatus').classList.add('active');
                    logToTerminal('‚úì Wake Lock –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'system');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                    document.addEventListener('visibilitychange', async () => {
                        if (document.visibilityState === 'visible' && SystemState.voiceEnabled) {
                            try {
                                SystemState.wakeLock = await navigator.wakeLock.request('screen');
                                document.getElementById('wakeLockStatus').classList.add('active');
                                
                                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                                if (SystemState.speechRecognition && !SystemState.isProcessing) {
                                    setTimeout(() => {
                                        if (SystemState.voiceEnabled) {
                                            SystemState.speechRecognition.start();
                                            logToTerminal('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'system');
                                        }
                                    }, 500);
                                }
                            } catch (err) {
                                console.log('Wake Lock –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', err);
                            }
                        } else if (document.visibilityState === 'hidden' && SystemState.wakeLock) {
                            document.getElementById('wakeLockStatus').classList.remove('active');
                        }
                    });
                    
                } catch (err) {
                    logToTerminal('Wake Lock –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'system');
                }
            }
        }

        // ============================================
        // ESP32 –£–ü–†–ê–í–õ–ï–ù–ò–ï
        // ============================================
        async function testESP32Connection() {
            if (!SystemState.espIp) return false;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch —Å mode 'no-cors' –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                const response = await fetch(`http://${SystemState.espIp}/`, {
                    method: 'GET',
                    mode: 'no-cors',
                    signal: controller.signal
                }).catch(() => null);
                
                clearTimeout(timeoutId);
                
                SystemState.lastESP32Ping = Date.now();
                const pingIndicator = document.getElementById('espConnectionIndicator');
                const pingText = document.getElementById('espConnectionText');
                const lastPingText = document.getElementById('lastPingText');
                
                // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –≤—ã–±—Ä–æ—Å–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω–æ
                pingIndicator.className = 'status-indicator online';
                pingText.textContent = SystemState.translations[SystemState.language].espStatusConnected;
                lastPingText.textContent = `${Date.now() - SystemState.lastESP32Ping}–º—Å`;
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ESP32:', error);
                const pingIndicator = document.getElementById('espConnectionIndicator');
                const pingText = document.getElementById('espConnectionText');
                pingIndicator.className = 'status-indicator offline';
                pingText.textContent = SystemState.translations[SystemState.language].espStatusDisconnected;
                return false;
            }
        }

        function startConnectionMonitor() {
            if (SystemState.connectionMonitor) {
                clearInterval(SystemState.connectionMonitor);
            }
            
            if (SystemState.espIp) {
                SystemState.connectionMonitor = setInterval(() => {
                    testESP32Connection();
                }, 10000);
            }
        }

        // ============================================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
        // ============================================
        async function initializeSystem() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const espIp = document.getElementById('espIp').value.trim();
            
            if (!apiKey) {
                logToTerminal('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á OpenRouter', 'error');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            SystemState.apiKey = apiKey;
            SystemState.espIp = espIp;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            const initBtn = document.getElementById('initBtn');
            initBtn.disabled = true;
            initBtn.innerHTML = '<span>‚ö°</span><span>–ü–†–û–í–ï–†–ö–ê...</span>';
            
            logToTerminal('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...', 'system');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
                const testResponse = await fetch('https://openrouter.ai/api/v1/auth/key', {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                if (!testResponse.ok) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á');
                }
                
                logToTerminal('‚úì API –∫–ª—é—á –ø—Ä–æ–≤–µ—Ä–µ–Ω', 'system');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
                if (!initSpeechRecognition()) {
                    throw new Error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏');
                }
                
                // –í–∫–ª—é—á–∞–µ–º Wake Lock
                await enableWakeLock();
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º ESP32
                if (espIp) {
                    await testESP32Connection();
                    startConnectionMonitor();
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É
                SystemState.systemActive = true;
                document.getElementById('testBtn').disabled = false;
                
                updateStatusDisplay();
                updateVoiceStatus('waiting');
                
                logToTerminal('‚úì –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'system');
                logToTerminal('–ê–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã: "–ø–∏–∫—Å–µ–ª—å" –∏–ª–∏ "pixel"', 'system');
                logToTerminal(`–†–µ–∂–∏–º: ${SystemState.mode.toUpperCase()}`, 'system');
                logToTerminal(`–Ø–∑—ã–∫: ${SystemState.language.toUpperCase()}`, 'system');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
                if (SystemState.visualizerInterval) {
                    clearInterval(SystemState.visualizerInterval);
                }
                SystemState.visualizerInterval = setInterval(updateVisualizer, 100);
                
            } catch (error) {
                logToTerminal(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                initBtn.disabled = false;
                initBtn.innerHTML = '<span>‚ö°</span><span id="initText">–ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨</span>';
            }
        }

        async function toggleVoiceControl() {
            if (!SystemState.systemActive) {
                logToTerminal('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É', 'error');
                return;
            }
            
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');
            const t = SystemState.translations[SystemState.language];
            
            if (!SystemState.voiceEnabled) {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
                const hasPermission = await requestMicrophonePermission();
                if (!hasPermission) {
                    logToTerminal(t.microphoneTestFail, 'error');
                    return;
                }
                
                // –í–∫–ª—é—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                SystemState.voiceEnabled = true;
                voiceToggleBtn.innerHTML = '<span>üîá</span><span id="voiceToggleText">' + t.voiceToggleOffText + '</span>';
                logToTerminal(t.voiceControlEnabled, 'system');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                if (SystemState.speechRecognition) {
                    SystemState.speechRecognition.start();
                }
                
                SystemState.retryCount = 0;
                
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                SystemState.voiceEnabled = false;
                voiceToggleBtn.innerHTML = '<span>üé§</span><span id="voiceToggleText">' + t.voiceToggleText + '</span>';
                logToTerminal(t.voiceControlDisabled, 'system');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                if (SystemState.speechRecognition) {
                    SystemState.speechRecognition.stop();
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—á—å
                if (SystemState.speechSynthesis) {
                    window.speechSynthesis.cancel();
                }
                
                // –û—á–∏—â–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
                document.getElementById('voiceVisualizer').innerHTML = '';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
                SystemState.listeningForActivation = false;
                SystemState.listeningForCommand = false;
            }
            
            updateStatusDisplay();
            updateVoiceStatus(SystemState.voiceEnabled ? 'waiting' : 'disabled');
        }

        async function testConnections() {
            if (!SystemState.systemActive) {
                logToTerminal('–°–∏—Å—Ç–µ–º–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'error');
                return;
            }
            
            const t = SystemState.translations[SystemState.language];
            logToTerminal(t.systemTestStarted, 'system');
            
            // –¢–µ—Å—Ç AI
            try {
                await fetch('https://openrouter.ai/api/v1/auth/key', {
                    headers: { 'Authorization': `Bearer ${SystemState.apiKey}` }
                });
                logToTerminal('‚úì AI —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: OK', 'system');
            } catch {
                logToTerminal('‚úó AI —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: –û–®–ò–ë–ö–ê', 'error');
            }
            
            // –¢–µ—Å—Ç ESP32
            if (SystemState.espIp) {
                const espConnected = await testESP32Connection();
                logToTerminal(espConnected ? '‚úì ESP32: OK' : '‚úó ESP32: –û–®–ò–ë–ö–ê', espConnected ? 'system' : 'error');
            }
            
            logToTerminal(t.systemTestComplete, 'system');
        }

        async function testMicrophone() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                logToTerminal('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return;
            }
            
            const t = SystemState.translations[SystemState.language];
            logToTerminal('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...', 'system');
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Ç–æ–∫ –∏–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π
                if (!SystemState.microphoneStream) {
                    SystemState.microphoneStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true 
                    });
                }
                
                logToTerminal(t.microphoneTestSuccess, 'system');
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ç–æ–∫ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ (–µ—Å–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ)
                if (!SystemState.voiceEnabled) {
                    setTimeout(() => {
                        SystemState.microphoneStream.getTracks().forEach(track => track.stop());
                        SystemState.microphoneStream = null;
                        SystemState.microphoneGranted = false;
                    }, 1000);
                }
                
            } catch (error) {
                logToTerminal(t.microphoneTestFail, 'error');
            }
        }

        function resetSystem() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
            if (SystemState.speechRecognition) {
                SystemState.speechRecognition.stop();
            }
            
            if (SystemState.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            if (SystemState.visualizerInterval) {
                clearInterval(SystemState.visualizerInterval);
                SystemState.visualizerInterval = null;
            }
            
            if (SystemState.connectionMonitor) {
                clearInterval(SystemState.connectionMonitor);
                SystemState.connectionMonitor = null;
            }
            
            if (SystemState.wakeLock) {
                SystemState.wakeLock.release();
                SystemState.wakeLock = null;
                document.getElementById('wakeLockStatus').classList.remove('active');
            }
            
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
            if (SystemState.microphoneStream) {
                SystemState.microphoneStream.getTracks().forEach(track => track.stop());
                SystemState.microphoneStream = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            SystemState.systemActive = false;
            SystemState.voiceEnabled = false;
            SystemState.listeningForActivation = false;
            SystemState.listeningForCommand = false;
            SystemState.isProcessing = false;
            SystemState.isSpeaking = false;
            SystemState.microphoneGranted = false;
            SystemState.retryCount = 0;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
            updateStatusDisplay();
            updateVoiceStatus('disabled');
            
            const t = SystemState.translations[SystemState.language];
            
            document.getElementById('initBtn').disabled = false;
            document.getElementById('initBtn').innerHTML = '<span>‚ö°</span><span id="initText">' + t.initText + '</span>';
            document.getElementById('testBtn').disabled = true;
            
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');
            voiceToggleBtn.innerHTML = '<span>üé§</span><span id="voiceToggleText">' + t.voiceToggleText + '</span>';
            
            document.getElementById('voiceVisualizer').innerHTML = '';
            
            logToTerminal(t.systemReset, 'system');
        }

        function clearTerminal() {
            const terminal = document.getElementById('terminal');
            terminal.innerHTML = '';
            SystemState.logEntries = 0;
            updateMemoryStatus();
            
            const t = SystemState.translations[SystemState.language];
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            terminal.innerHTML = `
                <div class="message system">
                    ${t.welcomeMessage}
                    <span class="message-timestamp">${timestamp}</span>
                </div>
            `;
        }

        function clearTextInput() {
            document.getElementById('textInput').value = '';
        }

        function exportLogs() {
            const messages = document.querySelectorAll('.message');
            let logContent = `Neural Terminal Logs\nGenerated: ${new Date().toLocaleString()}\nLanguage: ${SystemState.language}\n\n`;
            
            messages.forEach(msg => {
                const text = msg.textContent.replace(/\s+/g, ' ').trim();
                const type = msg.classList.contains('system') ? '[SYSTEM]' :
                             msg.classList.contains('ai') ? '[AI]' :
                             msg.classList.contains('user') ? '[USER]' : '[ERROR]';
                logContent += `${type} ${text}\n`;
            });
            
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `neural-terminal-logs-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logToTerminal('–õ–æ–≥–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'system');
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const savedApiKey = localStorage.getItem('neural_api_key');
            const savedEspIp = localStorage.getItem('neural_esp_ip');
            const savedLanguage = localStorage.getItem('neural_language') || 'ru';
            const savedMode = localStorage.getItem('neural_mode') || 'voice';
            
            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedEspIp) document.getElementById('espIp').value = savedEspIp;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –∏ —Ä–µ–∂–∏–º
            setLanguage(savedLanguage);
            setMode(savedMode);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('apiKey').addEventListener('input', (e) => {
                localStorage.setItem('neural_api_key', e.target.value);
            });
            
            document.getElementById('espIp').addEventListener('input', (e) => {
                localStorage.setItem('neural_esp_ip', e.target.value);
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —è–∑—ã–∫–∞ –∏ —Ä–µ–∂–∏–º–∞
            document.getElementById('langRu').addEventListener('click', () => {
                localStorage.setItem('neural_language', 'ru');
            });
            
            document.getElementById('langEn').addEventListener('click', () => {
                localStorage.setItem('neural_language', 'en');
            });
            
            document.getElementById('modeVoice').addEventListener('click', () => {
                localStorage.setItem('neural_mode', 'voice');
            });
            
            document.getElementById('modeTextBtn').addEventListener('click', () => {
                localStorage.setItem('neural_mode', 'text');
            });
            
            document.getElementById('modeHybrid').addEventListener('click', () => {
                localStorage.setItem('neural_mode', 'hybrid');
            });
            
            // –ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
            document.getElementById('textInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextRequest();
                }
            });
            
            document.getElementById('apiKey').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') initializeSystem();
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
            function updateTime() {
                const now = new Date();
                document.getElementById('currentTime').textContent = now.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            setInterval(updateTime, 1000);
            updateTime();
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && SystemState.systemActive) {
                    logToTerminal('–°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'system');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º ESP32 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    if (SystemState.espIp) {
                        testESP32Connection();
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ
                    if (SystemState.voiceEnabled && SystemState.speechRecognition && !SystemState.isProcessing) {
                        setTimeout(() => {
                            if (SystemState.voiceEnabled) {
                                SystemState.speechRecognition.start();
                                logToTerminal('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'system');
                            }
                        }, 500);
                    }
                }
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
            window.addEventListener('beforeunload', (e) => {
                if (SystemState.voiceEnabled) {
                    e.preventDefault();
                    e.returnValue = SystemState.language === 'ru' 
                        ? '–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?' 
                        : 'Voice control is active. Are you sure you want to leave the page?';
                    return e.returnValue;
                }
            });
            
            logToTerminal('Neural Terminal v3.2 –∑–∞–≥—Ä—É–∂–µ–Ω', 'system');
            logToTerminal('–ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ —Å–∞–π—Ç–µ: https://openrouter.ai', 'system');
        });
    </script>
</body>
</html>