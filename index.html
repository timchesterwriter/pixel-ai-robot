<!DOCTYPE html>
<html lang="ru" id="htmlLang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIXEL AI: Trinity Edition</title>
    <style>
        :root {
            --neon-primary: #00ff9d;
            --neon-secondary: #0094ff;
            --neon-accent: #ff00e5;
            --neon-warning: #ff4757;
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #222222;
            --text-primary: #ffffff;
            --text-secondary: #b0b7c3;
            --border-color: rgba(0, 255, 157, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg-primary);
            color: var(--neon-primary);
            font-family: 'Courier New', 'Cascadia Code', 'Monaco', monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            line-height: 1.6;
        }

        /* Header Status Bar */
        .status-bar {
            padding: 12px 20px;
            font-size: 12px;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .logo {
            font-weight: bold;
            letter-spacing: 1px;
        }

        .status-indicators {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neon-warning);
            box-shadow: 0 0 5px var(--neon-warning);
        }

        .status-dot.active {
            background: var(--neon-primary);
            box-shadow: 0 0 10px var(--neon-primary);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--neon-primary);
            box-shadow: 0 0 10px var(--neon-primary);
        }

        .status-dot.disconnected {
            background: var(--neon-warning);
            box-shadow: 0 0 5px var(--neon-warning);
        }

        .status-dot.thinking {
            background: #00d2ff;
            box-shadow: 0 0 10px #00d2ff;
            animation: pulse 1s infinite;
        }

        .blink {
            animation: blinker 1s linear infinite;
        }

        /* Terminal */
        #terminal {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sys {
            color: #00d2ff;
        }

        .ai {
            color: #fff;
            border-left: 2px solid var(--neon-primary);
            padding-left: 10px;
            margin: 5px 0;
            background: rgba(0, 255, 157, 0.05);
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
        }

        .user {
            color: var(--neon-accent);
            border-left: 2px solid var(--neon-accent);
            padding-left: 10px;
            background: rgba(255, 0, 229, 0.05);
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
            align-self: flex-end;
            margin-right: 10px;
        }

        .err {
            color: var(--neon-warning);
            border-left: 2px solid var(--neon-warning);
            padding-left: 10px;
            background: rgba(255, 71, 87, 0.05);
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
        }

        .warning {
            color: #ffaa00;
            border-left: 2px solid #ffaa00;
            padding-left: 10px;
            background: rgba(255, 170, 0, 0.05);
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
        }

        /* Controls */
        .controls {
            padding: 20px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-top: 1px solid var(--border-color);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            font-size: 11px;
            color: var(--neon-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--neon-primary);
            padding: 14px;
            border-radius: 5px;
            outline: none;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus {
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);
            border-color: var(--neon-secondary);
        }

        input::placeholder {
            color: rgba(0, 255, 157, 0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            flex: 1;
            padding: 16px;
            background: var(--neon-primary);
            border: none;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            color: var(--bg-primary);
            text-transform: uppercase;
            font-family: inherit;
            font-size: 12px;
            letter-spacing: 1px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 157, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-secondary {
            background: transparent;
            color: var(--neon-primary);
            border: 1px solid var(--neon-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--neon-primary);
            color: var(--bg-primary);
        }

        .btn-esp {
            background: transparent;
            color: var(--neon-secondary);
            border: 1px solid var(--neon-secondary);
        }

        .btn-esp:hover:not(:disabled) {
            background: var(--neon-secondary);
            color: var(--bg-primary);
        }

        /* Language Selector */
        .language-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .lang-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.3s;
        }

        .lang-btn.active {
            background: var(--neon-primary);
            color: var(--bg-primary);
            border-color: var(--neon-primary);
        }

        /* Voice Status Display */
        .voice-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            background: rgba(0, 255, 157, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Animations */
        @keyframes blinker {
            50% { opacity: 0; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        #terminal::-webkit-scrollbar {
            width: 6px;
        }

        #terminal::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        #terminal::-webkit-scrollbar-thumb {
            background: var(--neon-primary);
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
                padding: 10px;
            }
            
            .status-indicators {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <div class="logo">PIXEL AI: Trinity Edition <span class="blink">_</span></div>
        <div class="status-indicators">
            <div class="status-item">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">READY</span>
            </div>
            <div class="status-item">
                <span>LANG:</span>
                <span id="currentLang">RU</span>
            </div>
            <div class="status-item">
                <span>ESP32:</span>
                <div class="status-dot disconnected" id="espStatusDot"></div>
                <span id="espStatusText">DISCONNECTED</span>
            </div>
        </div>
    </div>

    <div id="terminal">
        <div class="warning">> –í–ù–ò–ú–ê–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥–µ–ª—å arcee-ai/trinity-large-preview:free</div>
        <div class="warning">> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à API –∫–ª—é—á OpenRouter –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏</div>
        <div class="sys">> –°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á OpenRouter –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.</div>
        <div class="sys">> –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞: https://openrouter.ai</div>
        <div class="sys">> –ê–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã: "–ø–∏–∫—Å–µ–ª—å" (—Ä—É—Å—Å–∫–∏–π) –∏–ª–∏ "pixel" (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)</div>
    </div>

    <div class="controls" id="setup">
        <div class="input-group">
            <div class="input-label">OPENROUTER API KEY</div>
            <input type="password" id="apiKey" placeholder="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxx">
        </div>
        
        <div class="button-group">
            <button onclick="initializeSystem()" id="initBtn">
                <span>‚ö°</span>
                <span>–ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨ –°–ò–°–¢–ï–ú–£</span>
            </button>
        </div>
        
        <div class="input-group" id="espSection" style="display: none;">
            <div class="input-label">ESP32 IP –ê–î–†–ï–°</div>
            <div class="button-group">
                <input type="text" id="espIp" placeholder="192.168.1.100" style="flex: 3;">
                <button onclick="connectToESP32()" id="espConnectBtn" class="btn-esp" style="flex: 1;">
                    <span>üîó</span>
                    <span>–ü–û–î–ö–õ–Æ–ß–ò–¢–¨</span>
                </button>
            </div>
        </div>
        
        <div class="language-selector">
            <button class="lang-btn active" onclick="setLanguage('ru')">–†–£–°–°–ö–ò–ô</button>
            <button class="lang-btn" onclick="setLanguage('en')">ENGLISH</button>
        </div>
        
        <div class="voice-status" id="voiceStatus">
            –°–∏—Å—Ç–µ–º–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
        </div>
        
        <div class="button-group" id="voiceControls" style="display: none;">
            <button onclick="toggleVoiceControl()" id="voiceToggleBtn" class="btn-secondary">
                <span>üé§</span>
                <span>–í–ö–õ–Æ–ß–ò–¢–¨ –ì–û–õ–û–°</span>
            </button>
            <button onclick="testMicrophone()" id="testMicBtn" class="btn-secondary">
                <span>üéß</span>
                <span>–¢–ï–°–¢ –ú–ò–ö–†–û–§–û–ù–ê</span>
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // ============================================
        const SystemState = {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            apiKey: '',
            espIp: '',
            language: 'ru',
            
            // –°–æ—Å—Ç–æ—è–Ω–∏—è
            systemActive: false,
            voiceEnabled: false,
            listeningForActivation: false,
            listeningForCommand: false,
            isProcessing: false,
            isSpeaking: false,
            espConnected: false,
            espTesting: false,
            
            // –û–±—ä–µ–∫—Ç—ã
            speechRecognition: null,
            speechSynthesis: window.speechSynthesis,
            wakeLock: null,
            
            // –¢–µ–∫—Å—Ç—ã –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            translations: {
                ru: {
                    // –°–æ–æ–±—â–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                    statusReady: "–ì–û–¢–û–í",
                    statusListeningName: "–°–õ–£–®–ê–Æ (–ò–ú–Ø)",
                    statusReplying: "–û–¢–í–ï–ß–ê–Æ",
                    statusListeningCmd: "–°–õ–£–®–ê–Æ (–ö–û–ú–ê–ù–î–ê)",
                    statusThinking: "–î–£–ú–ê–Æ",
                    
                    // –ö–Ω–æ–ø–∫–∏
                    initSystem: "–ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨ –°–ò–°–¢–ï–ú–£",
                    enableVoice: "–í–ö–õ–Æ–ß–ò–¢–¨ –ì–û–õ–û–°",
                    disableVoice: "–í–´–ö–õ–Æ–ß–ò–¢–¨ –ì–û–õ–û–°",
                    testMic: "–¢–ï–°–¢ –ú–ò–ö–†–û–§–û–ù–ê",
                    connectESP: "–ü–û–î–ö–õ–Æ–ß–ò–¢–¨",
                    connectingESP: "–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...",
                    disconnectESP: "–û–¢–ö–õ–Æ–ß–ò–¢–¨",
                    
                    // –°—Ç–∞—Ç—É—Å ESP32
                    espConnecting: "–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...",
                    espConnected: "–ü–û–î–ö–õ–Æ–ß–ï–ù",
                    espDisconnected: "–û–¢–ö–õ–Æ–ß–ï–ù",
                    espError: "–û–®–ò–ë–ö–ê",
                    
                    // –°—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–∞
                    voiceDisabled: "–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ",
                    voiceWaiting: "–û–∂–∏–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–π —Ñ—Ä–∞–∑—ã...",
                    voiceReady: "–ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—É...",
                    voiceProcessing: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã...",
                    voiceSpeaking: "–û—Ç–≤–µ—á–∞—é...",
                    
                    // –û—Ç–≤–µ—Ç—ã —Ä–æ–±–æ—Ç–∞
                    activationResponse: "–°–ª—É—à–∞—é —Ç–µ–±—è!",
                    
                    // –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    systemInitialized: "–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞",
                    voiceEnabledMsg: "–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ",
                    voiceDisabledMsg: "–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ",
                    microphoneTestSuccess: "–ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ",
                    microphoneTestFail: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É",
                    espConnectedMsg: "ESP32 –ø–æ–¥–∫–ª—é—á–µ–Ω",
                    espDisconnectedMsg: "ESP32 –æ—Ç–∫–ª—é—á–µ–Ω",
                    espErrorMsg: "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ESP32"
                },
                en: {
                    // Interface messages
                    statusReady: "READY",
                    statusListeningName: "LISTENING (NAME)",
                    statusReplying: "REPLYING",
                    statusListeningCmd: "LISTENING (COMMAND)",
                    statusThinking: "THINKING",
                    
                    // Buttons
                    initSystem: "INITIALIZE SYSTEM",
                    enableVoice: "ENABLE VOICE",
                    disableVoice: "DISABLE VOICE",
                    testMic: "TEST MICROPHONE",
                    connectESP: "CONNECT",
                    connectingESP: "CONNECTING...",
                    disconnectESP: "DISCONNECT",
                    
                    // ESP32 Status
                    espConnecting: "CONNECTING...",
                    espConnected: "CONNECTED",
                    espDisconnected: "DISCONNECTED",
                    espError: "ERROR",
                    
                    // Voice status
                    voiceDisabled: "Voice control disabled",
                    voiceWaiting: "Waiting for activation phrase...",
                    voiceReady: "Ready for command...",
                    voiceProcessing: "Processing command...",
                    voiceSpeaking: "Speaking...",
                    
                    // Robot responses
                    activationResponse: "I'm listening!",
                    
                    // System messages
                    systemInitialized: "System activated",
                    voiceEnabledMsg: "Voice control enabled",
                    voiceDisabledMsg: "Voice control disabled",
                    microphoneTestSuccess: "Microphone working normally",
                    microphoneTestFail: "Failed to access microphone",
                    espConnectedMsg: "ESP32 connected",
                    espDisconnectedMsg: "ESP32 disconnected",
                    espErrorMsg: "Error connecting to ESP32"
                }
            }
        };

        // ============================================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // ============================================
        function logToTerminal(message, type = 'sys') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            
            line.className = type;
            line.innerHTML = `> ${message}`;
            line.style.animation = 'slideIn 0.3s ease-out';
            
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateStatus(status, indicator = 'ready') {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            
            statusText.textContent = status;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã
            statusDot.className = 'status-dot';
            
            if (indicator === 'active') {
                statusDot.classList.add('active');
            } else if (indicator === 'thinking') {
                statusDot.classList.add('thinking');
            }
        }

        function updateESPStatus(connected, connecting = false) {
            const espStatusDot = document.getElementById('espStatusDot');
            const espStatusText = document.getElementById('espStatusText');
            const espConnectBtn = document.getElementById('espConnectBtn');
            const t = SystemState.translations[SystemState.language];
            
            if (connecting) {
                espStatusDot.className = 'status-dot thinking';
                espStatusText.textContent = t.espConnecting;
                espConnectBtn.disabled = true;
                espConnectBtn.innerHTML = '<span>‚è≥</span><span>' + t.connectingESP + '</span>';
            } else if (connected) {
                SystemState.espConnected = true;
                espStatusDot.className = 'status-dot connected';
                espStatusText.textContent = t.espConnected;
                espConnectBtn.disabled = false;
                espConnectBtn.innerHTML = '<span>üîó</span><span>' + t.disconnectESP + '</span>';
                logToTerminal(t.espConnectedMsg, 'sys');
            } else {
                SystemState.espConnected = false;
                espStatusDot.className = 'status-dot disconnected';
                espStatusText.textContent = t.espDisconnected;
                espConnectBtn.disabled = false;
                espConnectBtn.innerHTML = '<span>üîó</span><span>' + t.connectESP + '</span>';
                logToTerminal(t.espDisconnectedMsg, 'sys');
            }
        }

        function updateVoiceStatus(message) {
            const voiceStatus = document.getElementById('voiceStatus');
            voiceStatus.textContent = message;
        }

        function setLanguage(lang) {
            SystemState.language = lang;
            document.getElementById('htmlLang').lang = lang;
            document.getElementById('currentLang').textContent = lang.toUpperCase();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —è–∑—ã–∫–∞
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateInterfaceLanguage();
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ
            if (SystemState.voiceEnabled && SystemState.speechRecognition) {
                restartSpeechRecognition();
            }
            
            logToTerminal(lang === 'ru' ? '–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ –†—É—Å—Å–∫–∏–π' : 'Language changed to English', 'sys');
        }

        function updateInterfaceLanguage() {
            const t = SystemState.translations[SystemState.language];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('initBtn').querySelector('span:nth-child(2)').textContent = t.initSystem;
            
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');
            if (voiceToggleBtn) {
                if (SystemState.voiceEnabled) {
                    voiceToggleBtn.querySelector('span:nth-child(2)').textContent = t.disableVoice;
                } else {
                    voiceToggleBtn.querySelector('span:nth-child(2)').textContent = t.enableVoice;
                }
            }
            
            if (document.getElementById('testMicBtn')) {
                document.getElementById('testMicBtn').querySelector('span:nth-child(2)').textContent = t.testMic;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º ESP32 —Å—Ç–∞—Ç—É—Å
            updateESPStatus(SystemState.espConnected, SystemState.espTesting);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–∞
            if (SystemState.voiceEnabled) {
                if (SystemState.listeningForActivation) {
                    updateVoiceStatus(t.voiceWaiting);
                } else if (SystemState.listeningForCommand) {
                    updateVoiceStatus(t.voiceReady);
                } else if (SystemState.isProcessing) {
                    updateVoiceStatus(t.voiceProcessing);
                } else if (SystemState.isSpeaking) {
                    updateVoiceStatus(t.voiceSpeaking);
                }
            } else {
                updateVoiceStatus(t.voiceDisabled);
            }
        }

        // ============================================
        // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ESP32
        // ============================================
        async function connectToESP32() {
            const espIp = document.getElementById('espIp').value.trim();
            
            if (!espIp) {
                logToTerminal('–í–≤–µ–¥–∏—Ç–µ IP –∞–¥—Ä–µ—Å ESP32', 'err');
                return;
            }
            
            SystemState.espIp = espIp;
            SystemState.espTesting = true;
            updateESPStatus(false, true);
            
            logToTerminal('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ESP32...', 'sys');
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                const response = await fetch(`http://${espIp}/`, {
                    method: 'GET',
                    mode: 'no-cors',
                    signal: controller.signal
                }).catch(() => null);
                
                clearTimeout(timeoutId);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º IP –≤ localStorage
                localStorage.setItem('pixel_esp_ip', espIp);
                
                SystemState.espConnected = true;
                SystemState.espTesting = false;
                updateESPStatus(true);
                
                logToTerminal('‚úì ESP32 –¥–æ—Å—Ç—É–ø–µ–Ω', 'sys');
                
            } catch (error) {
                SystemState.espTesting = false;
                updateESPStatus(false);
                
                const t = SystemState.translations[SystemState.language];
                logToTerminal(t.espErrorMsg, 'err');
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ESP32:', error);
            }
        }

        // ============================================
        // –°–ò–°–¢–ï–ú–ê –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø –†–ï–ß–ò
        // ============================================
        async function initializeSpeechRecognition() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                logToTerminal('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏', 'err');
                return false;
            }
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ç–æ–∫ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                    stream.getTracks().forEach(track => track.stop());
                    
                    logToTerminal('‚úì –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω–æ', 'sys');
                }
            } catch (error) {
                logToTerminal('‚ö† –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ', 'err');
                return false;
            }
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            SystemState.speechRecognition = new SpeechRecognition();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            SystemState.speechRecognition.continuous = false;
            SystemState.speechRecognition.interimResults = false;
            SystemState.speechRecognition.lang = SystemState.language === 'ru' ? 'ru-RU' : 'en-US';
            SystemState.speechRecognition.maxAlternatives = 1;
            
            // –°–æ–±—ã—Ç–∏—è
            SystemState.speechRecognition.onstart = () => {
                console.log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å');
            };
            
            SystemState.speechRecognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                const confidence = event.results[0][0].confidence;
                
                console.log(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}" (${(confidence * 100).toFixed(1)}%)`);
                logToTerminal(`–°–ª—ã—à—É: "${transcript}"`, 'user');
                
                if (SystemState.listeningForActivation) {
                    handleActivation(transcript);
                } else if (SystemState.listeningForCommand) {
                    handleCommand(transcript);
                }
            };
            
            SystemState.speechRecognition.onerror = (event) => {
                if (event.error === 'no-speech' || event.error === 'audio-capture') {
                    // –¢–∏—Ö–∏–µ –æ—à–∏–±–∫–∏ - –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
                    if (SystemState.voiceEnabled) {
                        setTimeout(startRecognition, 100);
                    }
                    return;
                }
                
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
                
                if (SystemState.voiceEnabled) {
                    setTimeout(startRecognition, 1000);
                }
            };
            
            SystemState.speechRecognition.onend = () => {
                if (SystemState.voiceEnabled) {
                    setTimeout(startRecognition, 100);
                }
            };
            
            return true;
        }

        function startRecognition() {
            if (!SystemState.voiceEnabled || !SystemState.speechRecognition) return;
            
            try {
                SystemState.speechRecognition.start();
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                if (SystemState.voiceEnabled) {
                    setTimeout(startRecognition, 1000);
                }
            }
        }

        function restartSpeechRecognition() {
            if (SystemState.speechRecognition) {
                SystemState.speechRecognition.stop();
                setTimeout(() => {
                    if (SystemState.voiceEnabled) {
                        SystemState.speechRecognition.lang = SystemState.language === 'ru' ? 'ru-RU' : 'en-US';
                        startRecognition();
                    }
                }, 300);
            }
        }

        function handleActivation(transcript) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —è–∑—ã–∫–∞
            if (transcript.includes('–ø–∏–∫—Å–µ–ª—å') || transcript.includes('pixel')) {
                logToTerminal('‚úì –ê–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞', 'sys');
                
                SystemState.listeningForActivation = false;
                SystemState.listeningForCommand = false;
                SystemState.isProcessing = true;
                
                updateStatus(SystemState.translations[SystemState.language].statusReplying, 'thinking');
                updateVoiceStatus(SystemState.translations[SystemState.language].voiceProcessing);
                
                // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é
                const response = SystemState.translations[SystemState.language].activationResponse;
                speakText(response);
                
                logToTerminal(`PIXEL: ${response}`, 'sys');
            } else {
                // –ï—Å–ª–∏ –Ω–µ —É—Å–ª—ã—à–∞–ª–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–ª—É—à–∞—Ç—å
                startRecognition();
            }
        }

        function handleCommand(transcript) {
            SystemState.listeningForCommand = false;
            SystemState.isProcessing = true;
            
            updateStatus(SystemState.translations[SystemState.language].statusThinking, 'thinking');
            updateVoiceStatus(SystemState.translations[SystemState.language].voiceProcessing);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            if (SystemState.speechRecognition) {
                SystemState.speechRecognition.stop();
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ AI
            processAIRequest(transcript);
        }

        // ============================================
        // AI –û–ë–†–ê–ë–û–¢–ö–ê (ARCEE TRINITY)
        // ============================================
        async function processAIRequest(prompt) {
            try {
                logToTerminal('Trinity AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å...', 'sys');
                
                // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±–µ–∑ —Å–º–∞–π–ª–∏–∫–æ–≤ –∏ —Å —á–µ—Ç–∫–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
                const systemPrompt = SystemState.language === 'ru' 
                    ? `–¢—ã —Ä–æ–±–æ—Ç –ü–∏–∫—Å–µ–ª—å. –û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ (1-2 —Ñ—Ä–∞–∑—ã). 
                       –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –∏–ª–∏ —ç–º–æ–¥–∑–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö.
                       –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã:
                       LED_ON - –≤–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç, LED_OFF - –≤—ã–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç.
                       –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å—Ç—Ä–æ–≥–æ: Text: [—Ç–≤–æ–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞] Commands: [–∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ null]
                       –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ "Text:" –±—É–¥–µ—Ç –æ–∑–≤—É—á–µ–Ω –∏ –ø–æ–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.`
                    : `You are Pixel robot. Respond very briefly (1-2 phrases).
                       Do not use smileys or emojis in responses.
                       If you need to control devices, use commands:
                       LED_ON - turn on lights, LED_OFF - turn off lights.
                       Response format strictly: Text: [your response text] Commands: [command or null]
                       Only text after "Text:" will be spoken and shown to the user.`;
                
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${SystemState.apiKey}`,
                        "HTTP-Referer": window.location.href,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "arcee-ai/trinity-large-preview:free",
                        "messages": [
                            {
                                "role": "system",
                                "content": systemPrompt
                            },
                            { "role": "user", "content": prompt }
                        ],
                        "temperature": 0.7,
                        "max_tokens": 150
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || '–û—à–∏–±–∫–∞ API');
                }

                if (!data.choices || !data.choices[0]) {
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API');
                }

                const aiRaw = data.choices[0].message.content;
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–æ–º–∞–Ω–¥—É
                const textMatch = aiRaw.match(/Text:\s*(.*?)(?:\s*Commands:|$)/i);
                const commandMatch = aiRaw.match(/Commands:\s*(\w+)/i);
                
                const txt = textMatch ? textMatch[1].trim() : aiRaw;
                const cmd = commandMatch ? commandMatch[1].toUpperCase() : "null";

                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∞
                const cleanText = txt.replace(/Commands:\s*\w+/i, '').trim();
                
                logToTerminal(`PIXEL: ${cleanText}`, 'ai');

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ ESP32 –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                if (cmd !== "NULL" && cmd !== "null" && SystemState.espConnected && SystemState.espIp) {
                    try {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º img –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã (–æ–±—Ö–æ–¥ CORS)
                        const img = new Image();
                        img.src = `http://${SystemState.espIp}/command?cmd=${encodeURIComponent(cmd)}&_=${Date.now()}`;
                        
                        img.onload = () => {
                            logToTerminal(`–ö–æ–º–∞–Ω–¥–∞ [${cmd}] –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ ESP32`, 'sys');
                        };
                        
                        img.onerror = () => {
                            logToTerminal(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ ESP32`, 'err');
                        };
                        
                    } catch (e) {
                        logToTerminal(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã: ${e.message}`, 'err');
                    }
                }

                // –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ –∫–æ–º–∞–Ω–¥)
                speakText(cleanText);

            } catch (error) {
                logToTerminal(`–û–®–ò–ë–ö–ê: ${error.message}`, 'err');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—é
                setTimeout(() => {
                    if (SystemState.voiceEnabled) {
                        SystemState.listeningForActivation = true;
                        updateStatus(SystemState.translations[SystemState.language].statusListeningName, 'active');
                        updateVoiceStatus(SystemState.translations[SystemState.language].voiceWaiting);
                        startRecognition();
                    }
                }, 1000);
            }
        }

        // ============================================
        // –°–ò–ù–¢–ï–ó –†–ï–ß–ò
        // ============================================
        function speakText(text) {
            if (!SystemState.speechSynthesis) return;
            
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = SystemState.language === 'ru' ? 'ru-RU' : 'en-US';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onstart = () => {
                SystemState.isSpeaking = true;
                updateVoiceStatus(SystemState.translations[SystemState.language].voiceSpeaking);
            };
            
            utterance.onend = () => {
                SystemState.isSpeaking = false;
                SystemState.isProcessing = false;
                
                // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
                SystemState.listeningForCommand = true;
                updateStatus(SystemState.translations[SystemState.language].statusListeningCmd, 'active');
                updateVoiceStatus(SystemState.translations[SystemState.language].voiceReady);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
                if (SystemState.voiceEnabled) {
                    startRecognition();
                }
            };
            
            utterance.onerror = () => {
                SystemState.isSpeaking = false;
                SystemState.isProcessing = false;
                
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∂–∏–¥–∞–Ω–∏—é –∫–æ–º–∞–Ω–¥—ã
                SystemState.listeningForCommand = true;
                updateStatus(SystemState.translations[SystemState.language].statusListeningCmd, 'active');
                updateVoiceStatus(SystemState.translations[SystemState.language].voiceReady);
                
                if (SystemState.voiceEnabled) {
                    startRecognition();
                }
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // ============================================
        // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –°–ò–°–¢–ï–ú–´
        // ============================================
        async function initializeSystem() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                logToTerminal('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á OpenRouter!', 'err');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            SystemState.apiKey = apiKey;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            const initBtn = document.getElementById('initBtn');
            initBtn.disabled = true;
            initBtn.innerHTML = '<span>‚è≥</span><span>–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø...</span>';
            
            updateStatus('INITIALIZING', 'thinking');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∫–ª—é—á –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏
                const testResponse = await fetch('https://openrouter.ai/api/v1/models', {
                    headers: { 
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!testResponse.ok) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á –∏–ª–∏ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ API');
                }
                
                const models = await testResponse.json();
                const trinityModel = models.data?.find(model => 
                    model.id === 'arcee-ai/trinity-large-preview:free'
                );
                
                if (!trinityModel) {
                    logToTerminal('‚ö† –ú–æ–¥–µ–ª—å Trinity –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ —Å –≤–∞—à–∏–º –∫–ª—é—á–æ–º', 'warning');
                }
                
                logToTerminal('‚úì API –∫–ª—é—á –ø—Ä–æ–≤–µ—Ä–µ–Ω', 'sys');
                logToTerminal('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥–µ–ª—å: arcee-ai/trinity-large-preview:free', 'sys');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏
                const speechInit = await initializeSpeechRecognition();
                if (!speechInit) {
                    throw new Error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏');
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É
                SystemState.systemActive = true;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–º –∏ ESP32
                document.getElementById('espSection').style.display = 'block';
                document.getElementById('voiceControls').style.display = 'flex';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateInterfaceLanguage();
                updateStatus(SystemState.translations[SystemState.language].statusReady, 'active');
                updateVoiceStatus(SystemState.translations[SystemState.language].voiceWaiting);
                
                logToTerminal('‚úì –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'sys');
                logToTerminal('–ê–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã: "–ø–∏–∫—Å–µ–ª—å" –∏–ª–∏ "pixel"', 'sys');
                logToTerminal(`–Ø–∑—ã–∫: ${SystemState.language.toUpperCase()}`, 'sys');
                logToTerminal('–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã: LED_ON, LED_OFF', 'sys');
                
                // –í–∫–ª—é—á–∞–µ–º Wake Lock –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if ('wakeLock' in navigator) {
                    try {
                        SystemState.wakeLock = await navigator.wakeLock.request('screen');
                        logToTerminal('‚úì Wake Lock –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'sys');
                    } catch (err) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É Wake Lock
                    }
                }
                
            } catch (error) {
                logToTerminal(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'err');
                initBtn.disabled = false;
                initBtn.innerHTML = '<span>‚ö°</span><span>–ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨ –°–ò–°–¢–ï–ú–£</span>';
                updateStatus('ERROR', 'ready');
            }
        }

        async function toggleVoiceControl() {
            if (!SystemState.systemActive) {
                logToTerminal('–°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É', 'err');
                return;
            }
            
            const voiceToggleBtn = document.getElementById('voiceToggleBtn');
            const t = SystemState.translations[SystemState.language];
            
            if (!SystemState.voiceEnabled) {
                // –í–∫–ª—é—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                SystemState.voiceEnabled = true;
                voiceToggleBtn.innerHTML = '<span>üîá</span><span>' + t.disableVoice + '</span>';
                logToTerminal(t.voiceEnabledMsg, 'sys');
                
                // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É
                SystemState.listeningForActivation = true;
                SystemState.listeningForCommand = false;
                
                updateStatus(t.statusListeningName, 'active');
                updateVoiceStatus(t.voiceWaiting);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                startRecognition();
                
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                SystemState.voiceEnabled = false;
                voiceToggleBtn.innerHTML = '<span>üé§</span><span>' + t.enableVoice + '</span>';
                logToTerminal(t.voiceDisabledMsg, 'sys');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                if (SystemState.speechRecognition) {
                    SystemState.speechRecognition.stop();
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—á—å
                if (SystemState.speechSynthesis) {
                    window.speechSynthesis.cancel();
                }
                
                updateStatus(t.statusReady, 'active');
                updateVoiceStatus(t.voiceDisabled);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
                SystemState.listeningForActivation = false;
                SystemState.listeningForCommand = false;
                SystemState.isProcessing = false;
                SystemState.isSpeaking = false;
            }
        }

        async function testMicrophone() {
            const t = SystemState.translations[SystemState.language];
            
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    logToTerminal(t.microphoneTestSuccess, 'sys');
                    
                    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ç–æ–∫
                    stream.getTracks().forEach(track => track.stop());
                } else {
                    throw new Error('API –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                }
            } catch (error) {
                logToTerminal(t.microphoneTestFail, 'err');
            }
        }

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const savedApiKey = localStorage.getItem('pixel_api_key');
            const savedEspIp = localStorage.getItem('pixel_esp_ip');
            const savedLanguage = localStorage.getItem('pixel_language') || 'ru';
            
            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedEspIp) {
                document.getElementById('espIp').value = savedEspIp;
                SystemState.espIp = savedEspIp;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫
            setLanguage(savedLanguage);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('apiKey').addEventListener('input', (e) => {
                localStorage.setItem('pixel_api_key', e.target.value);
            });
            
            document.getElementById('espIp').addEventListener('input', (e) => {
                localStorage.setItem('pixel_esp_ip', e.target.value);
            });
            
            // –ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
            document.getElementById('apiKey').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') initializeSystem();
            });
            
            document.getElementById('espIp').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connectToESP32();
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && SystemState.voiceEnabled) {
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Wake Lock
                    if ('wakeLock' in navigator && !SystemState.wakeLock) {
                        navigator.wakeLock.request('screen').then(wl => {
                            SystemState.wakeLock = wl;
                        });
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                    if (SystemState.speechRecognition && !SystemState.isProcessing) {
                        setTimeout(() => {
                            if (SystemState.voiceEnabled) {
                                startRecognition();
                                logToTerminal('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'sys');
                            }
                        }, 500);
                    }
                }
            });
            
            logToTerminal('PIXEL AI: Trinity Edition –∑–∞–≥—Ä—É–∂–µ–Ω', 'sys');
            logToTerminal('–ú–æ–¥–µ–ª—å: arcee-ai/trinity-large-preview:free', 'sys');
            logToTerminal('–ì–æ—Ç–æ–≤ –∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...', 'sys');
        });

        // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
        window.addEventListener('beforeunload', (e) => {
            if (SystemState.voiceEnabled) {
                e.preventDefault();
                e.returnValue = SystemState.language === 'ru' 
                    ? '–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?' 
                    : 'Voice control is active. Are you sure you want to leave the page?';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>